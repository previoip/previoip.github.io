<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-8HTK24ZVY8"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8HTK24ZVY8",{anonymize_ip:!1})}</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel=stylesheet><link rel=stylesheet type=text/css href="/css/styles.css?v=0.1.3"><link rel=stylesheet href="/css/highlight.css?v=1.0.1"><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script src="/js/main.js?v=0.1.1" defer></script><title>Python Hijinks: Outlook Safelink *Decoder* &ndash; dumb by default</title></head><body><div id=navbar><ul class=nav-col><li class=nav-item><a class=nav-link href=/>Home</a></li><li class=nav-item><a class=nav-link href=/about/>About</a></li><li class=nav-item><a class=nav-link href=/posts/>Posts</a></li><li class=nav-item><a class=nav-link href=/resources/>Resources</a></li></ul></div><div class=wrapper><article><header class=single><nav class=crumb><ol style=padding-left:0><li class=crumb><a href=/>Home</a></li><li class=crumb><a href=/posts/>Posts</a></li><li class="crumb active">Python Hijinks: Outlook Safelink *Decoder*</li></ol></nav><h1 class=header-title>Python Hijinks: Outlook Safelink *Decoder*</h1><pre style=margin:0>published-date: 21 Jan 2023 23:12 &#43;0700</pre><pre style=margin:0>categories: <a href=http://previoip.github.io/categories/python-hijinks/>python-hijinks</a></pre><pre style=margin:0>tags: <a href=http://previoip.github.io/tags/python/>python</a></pre></header><hr><h1 id=synopsis>Synopsis</h1><p>There were times when me and my colleague were asked to regularly update and copy links out of Outlook 365 mail to be inserted into certain form. But the url we copied were always too long, and the form they gave us has a character limit. For some reason (read: <em>good</em>), these links always redirect to Microsoft Office Defender unsafe malicious link detection system.</p><p>Here&rsquo;s a sample on how the link would look like if you copied directly from Outlook.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>https://your.company.windows.defender.domain.com/?url=https%3A//en.wikipedia.org/wiki/Sergeant_Reckless&amp;data=05%7C01%7Cmy.mail%40domain.com%7C46575da2930c2aa97e550b27b1090595%7Cd0dd9bc880d23c27c6e5821a10edc04e%7C1%7C0%7C844353527029278340%7CUnknown%7Cpegytgkototbwiuhiqkbodlblaacaxulmzsqdwdtgekwfuableebpvucgfhdobzygxpohqqcare%3D%7C3000%7C%7C%7C&amp;sdata=iXZKYIVxymHZqRIuefqinvbeXKHv%2BnRxdXMrYexvfRh%3D&amp;reserved=0
</span></span></code></pre></div><blockquote><p>Note all obfuscated data are manually randomized in this link. There&rsquo;s no use on decoding anything out of it.</p></blockquote><p>It&rsquo;s pretty obvious our target link is embedded and formatted as <a target=_blank class=extern href=https://en.wikipedia.org/wiki/Escape_character>escape characters</a> in the query <code>url</code> param. On top of that, the query goes through the defender system alongside additional payload, presumably the information of the receiver and the mail where it was copied. idk honestly.</p><p>Knowing it&rsquo;s there, I did a quick googling and found a tool online to extract the og link (site: <a target=_blank class=extern href=http://www.o365atp.com/>http://www.o365atp.com/</a>, which looks dodgy asf but I tested it and its safe ðŸ¤ž). I decided to write myself a little python script just in case the web went offline (it&rsquo;s just a python implementation of the website).</p><h1 id=the-script-tidbits>The Script Tidbits</h1><p>You can get the full version in my github repo: <a target=_blank class=extern href=https://github.com/previoip/outlook_365_safelink_decoder>Outlook Safelink Decoder</a> utilizing <code>urllib.parse</code> in python. Although the title itself is a bit misleading because it doesn&rsquo;t do any decoding at all.</p><p>This is a snippet of the only functional part of the script.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>safelinkDecode</span><span class=p>(</span><span class=n>url</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>urllib</span> <span class=kn>import</span> <span class=n>parse</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>parse</span><span class=o>.</span><span class=n>urlparse</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>query</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>query</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;tried to parse </span><span class=si>{</span><span class=n>url</span><span class=si>}</span><span class=s1>: </span><span class=se>\n\t</span><span class=s1>no valid query string in the given url&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>queryfragment</span> <span class=o>=</span> <span class=p>[</span><span class=n>i</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;=&#39;</span><span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>query</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;&amp;&#39;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>qkeys</span><span class=p>,</span> <span class=n>qvals</span> <span class=o>=</span> <span class=nb>tuple</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=o>*</span><span class=n>queryfragment</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>qvals</span> <span class=o>=</span> <span class=nb>map</span><span class=p>(</span><span class=n>parse</span><span class=o>.</span><span class=n>unquote</span><span class=p>,</span> <span class=n>qvals</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>queryfragment</span> <span class=o>=</span> <span class=nb>dict</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>qkeys</span><span class=p>,</span> <span class=n>qvals</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>queryfragment</span>
</span></span></code></pre></div><p>In summary, <code>urllib.parse.urlparse</code> is used to get the query parameter from the url. Because all of the characters are escaped or quoted, <code>urllib.parse.unquote</code> is used to unquote the quoted quote (try saying that out loud). The other stuff is just fancy way to unpack, map the unquote function into the value list, and wraps the result back into dictionary.</p><p>Passing previous link into this function will get this result.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://en.wikipedia.org/wiki/Sergeant_Reckless&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;data&#34;</span><span class=p>:</span> <span class=s2>&#34;05|01|my.mail@domain.com|46575da2930c2aa97e550b27b1090595|d0dd9bc880d23c27c6e5821a10edc04e|1|0|844353527029278340|Unknown|pegytgkototbwiuhiqkbodlblaacaxulmzsqdwdtgekwfuableebpvucgfhdobzygxpohqqcare=|3000|||&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;sdata&#34;</span><span class=p>:</span> <span class=s2>&#34;iXZKYIVxymHZqRIuefqinvbeXKHv+nRxdXMrYexvfRh=&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;reserved&#34;</span><span class=p>:</span> <span class=s2>&#34;0&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Aaand presto! the url now can be accessed from the <code>url</code> key.</p><p>P.S. it seems some of the additional payload data sent to Windows Defender is encoded in 32 character long (presumably base64), the sender email in plain text, other 75 characters mumbo jumbo in lowercase, and uses <code>|</code> as delimiter.</p></article></div><div id=footer><div style=display:flex;justify-content:center><small>Built with <a a target=_blank class=extern href=https://gohugo.io/>Hugo</a> | previoip &copy;2022</small></div></div></body></html>