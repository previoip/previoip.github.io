<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-8HTK24ZVY8"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8HTK24ZVY8")}</script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="/css/highlight.css?v=1.0.0"><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><style>:root{--f:1em;--w:30}html{margin:0 2em;max-width:calc(var(--f)*var(--w));font-size:var(--f)}body{margin:0;padding:0;font-family:monospace;scrollbar-face-color:ThreeDFace!important;scrollbar-shadow-color:ThreeDDarkShadow!important;scrollbar-highlight-color:ThreeDHighlight!important;scrollbar-3dlight-color:ThreeDLightShadow!important;scrollbar-darkshadow-color:ThreeDDarkShadow!important;scrollbar-track-color:Scrollbar!important;scrollbar-arrow-color:ButtonText!important}small{font-size:calc(var(--f)*.82)}*{font-size:inherit}p{padding-left:calc(var(--f)*1.6)}p canvas{outline:1px solid #000;width:calc(100% - var(--f)*1.6)}a{color:#1c69e5;text-decoration:underline}a:hover{color:#2072f5;text-decoration:none}a:active{color:#0062ff;text-decoration:none;background-color:var(--tx-c-hover)}blockquote{opacity:.75;background-color:#e9e61c68}div.mermaid .edgeLabel{padding:.2rem}img,div.mermaid svg{margin:auto;display:block;max-width:min(100%,calc(var(--f)*var(--w)));min-width:100px;background-color:#282a36;border-radius:.6rem}code:not([class]){background-color:#8e98d575;padding:0 .2em;border-radius:.2em}div.highlight pre{padding:1rem;border-radius:.6rem;overflow:scroll;overflow-y:auto;overflow-x:auto}div.highlight pre code span{margin-block-end:.1em}.disabled,.failed{pointer-events:none}.tc{padding-left:0;padding-right:0;text-align:center}.o50{opacity:.5}::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:#43454ce6;border-radius:3px}::-webkit-scrollbar-thumb{background:#c1cdf6e6;border-radius:3px}input,select{font:inherit}#control div{display:flex;align-items:center;margin-top:.6em}#control input,#control select{display:inline-block;margin:0 .5em}#control p{margin:0;width:2rem}</style><title>shazamio: shazam on your terminal &ndash; dumb by default</title></head><body><div style=background-color:#69696969><br><h1 class=tc>dumb by default</h1><nav class=tc>[<a href=/>Home</a>]&nbsp;[<a href=/about/>About</a>]&nbsp;[<a href=/posts/>Posts</a>]&nbsp;[<a href=/resources/>Resources</a>]&nbsp;[<a href=/applets/>Applets</a>]&nbsp;</nav><hr></div><p style=padding:0><span>dir: <i><a href=/>Home</a> /
<a href=/posts/>Posts</a> /
<span>shazamio: shazam on your terminal</span></i></span><br><span>published-date: 19 Feb 2025 15:02 +0700</span><br><span>categories: [<a href=http://previoip.github.io/categories/quickie/>quickie</a>] [<a href=http://previoip.github.io/categories/python-hijinks/>python-hijinks</a>]</span><br><span>tags: [<a href=http://previoip.github.io/tags/python/>python</a>]</span><br></p><h1 class=tc>shazamio: shazam on your terminal</h1><hr><div><p>I&rsquo;ve switched to soundcloud for a while now after knowing spotify&rsquo;s <a target=_blank class=extern href=https://ra.co/news/76439>questionable business practices</a>.</p><p>Living with soundcloud made me realize one thing: most dj sets does not provide track list. Which is a shame since those would otherwise advertise those tracks&rsquo;s artists, which also mostly are indies.
And I dont want to install shazam on my phone, afaik no free models/services are available to search songs through an open API&mldr;</p><p>&mldr; except <a target=_blank class=extern href=https://github.com/shazamio/ShazamIO>shazamio</a>!</p><p>Thus I wrote a quick hacky script to handle searching songs either from url or from file. Unfortunately not repo/gist worthy so here it is.</p><p>requires: ffmpeg, yt-dlp, shazamio (duh) and their deps respectively.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln>  1</span><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=ln>  2</span><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=ln>  3</span><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=ln>  4</span><span class=cl><span class=kn>import</span> <span class=nn>tempfile</span>
</span></span><span class=line><span class=ln>  5</span><span class=cl><span class=kn>from</span> <span class=nn>aiohttp_retry</span> <span class=kn>import</span> <span class=n>ExponentialRetry</span>
</span></span><span class=line><span class=ln>  6</span><span class=cl><span class=kn>from</span> <span class=nn>shazamio</span> <span class=kn>import</span> <span class=n>Shazam</span><span class=p>,</span> <span class=n>Serialize</span><span class=p>,</span> <span class=n>HTTPClient</span><span class=p>,</span> <span class=n>SearchParams</span>
</span></span><span class=line><span class=ln>  7</span><span class=cl><span class=kn>from</span> <span class=nn>yt_dlp</span> <span class=kn>import</span> <span class=n>YoutubeDL</span>
</span></span><span class=line><span class=ln>  8</span><span class=cl>
</span></span><span class=line><span class=ln>  9</span><span class=cl>
</span></span><span class=line><span class=ln> 10</span><span class=cl><span class=k>class</span> <span class=nc>Shazamnnn</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 11</span><span class=cl>
</span></span><span class=line><span class=ln> 12</span><span class=cl>  <span class=c1># change to relative/absolute path to executable</span>
</span></span><span class=line><span class=ln> 13</span><span class=cl>  <span class=c1># if not present on PATH env variable</span>
</span></span><span class=line><span class=ln> 14</span><span class=cl>  <span class=n>exec_ffmpeg</span> <span class=o>=</span> <span class=s1>&#39;ffmpeg&#39;</span>
</span></span><span class=line><span class=ln> 15</span><span class=cl>
</span></span><span class=line><span class=ln> 16</span><span class=cl>  <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=ln> 17</span><span class=cl>  <span class=k>def</span> <span class=nf>is_url</span><span class=p>(</span><span class=n>s</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 18</span><span class=cl>    <span class=c1># https://stackoverflow.com/questions/7160737/how-to-validate-a-url-in-python-malformed-or-not</span>
</span></span><span class=line><span class=ln> 19</span><span class=cl>    <span class=kn>from</span> <span class=nn>urllib.parse</span> <span class=kn>import</span> <span class=n>urlparse</span>
</span></span><span class=line><span class=ln> 20</span><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 21</span><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>urlparse</span><span class=p>(</span><span class=n>s</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 22</span><span class=cl>      <span class=k>return</span> <span class=nb>all</span><span class=p>([</span><span class=n>result</span><span class=o>.</span><span class=n>scheme</span><span class=p>,</span> <span class=n>result</span><span class=o>.</span><span class=n>netloc</span><span class=p>])</span>
</span></span><span class=line><span class=ln> 23</span><span class=cl>    <span class=k>except</span> <span class=ne>AttributeError</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 24</span><span class=cl>      <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=ln> 25</span><span class=cl>
</span></span><span class=line><span class=ln> 26</span><span class=cl>  <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=ln> 27</span><span class=cl>  <span class=k>def</span> <span class=nf>_sec_to_time_sig</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 28</span><span class=cl>    <span class=n>m</span><span class=p>,</span> <span class=n>s</span> <span class=o>=</span> <span class=nb>divmod</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 29</span><span class=cl>    <span class=n>h</span><span class=p>,</span> <span class=n>m</span> <span class=o>=</span> <span class=nb>divmod</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 30</span><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>h</span><span class=si>:</span><span class=s1>&gt;02d</span><span class=si>}</span><span class=s1>:</span><span class=si>{</span><span class=n>m</span><span class=si>:</span><span class=s1>&gt;02d</span><span class=si>}</span><span class=s1>:</span><span class=si>{</span><span class=n>s</span><span class=si>:</span><span class=s1>&gt;02d</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=ln> 31</span><span class=cl>
</span></span><span class=line><span class=ln> 32</span><span class=cl>  <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=ln> 33</span><span class=cl>  <span class=k>def</span> <span class=nf>_time_sig_to_sec</span><span class=p>(</span><span class=n>t</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 34</span><span class=cl>    <span class=c1># this does not handle stupid formatted time signature</span>
</span></span><span class=line><span class=ln> 35</span><span class=cl>    <span class=c1># beyond its intended purpose like 0:2131231491:69 or </span>
</span></span><span class=line><span class=ln> 36</span><span class=cl>    <span class=c1># foo:!!^*@^:zero or 2mins so be aware</span>
</span></span><span class=line><span class=ln> 37</span><span class=cl>    <span class=n>t</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>s</span> <span class=o>=</span> <span class=n>t</span><span class=o>.</span><span class=n>rpartition</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 38</span><span class=cl>    <span class=n>h</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>m</span> <span class=o>=</span> <span class=n>t</span><span class=o>.</span><span class=n>rpartition</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 39</span><span class=cl>    <span class=n>s</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=k>if</span> <span class=n>s</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=ln> 40</span><span class=cl>    <span class=n>m</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>m</span><span class=p>)</span> <span class=k>if</span> <span class=n>m</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=ln> 41</span><span class=cl>    <span class=n>h</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>h</span><span class=p>)</span> <span class=k>if</span> <span class=n>h</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=ln> 42</span><span class=cl>    <span class=n>m</span> <span class=o>+=</span> <span class=n>h</span> <span class=o>*</span> <span class=mi>60</span>
</span></span><span class=line><span class=ln> 43</span><span class=cl>    <span class=n>s</span> <span class=o>+=</span> <span class=n>m</span> <span class=o>*</span> <span class=mi>60</span>
</span></span><span class=line><span class=ln> 44</span><span class=cl>    <span class=k>return</span> <span class=n>s</span>
</span></span><span class=line><span class=ln> 45</span><span class=cl>
</span></span><span class=line><span class=ln> 46</span><span class=cl>  <span class=nd>@classmethod</span>
</span></span><span class=line><span class=ln> 47</span><span class=cl>  <span class=k>def</span> <span class=nf>_parse_seconds</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>t</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 48</span><span class=cl>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>t</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 49</span><span class=cl>      <span class=k>return</span> <span class=bp>cls</span><span class=o>.</span><span class=n>_time_sig_to_sec</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 50</span><span class=cl>    <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 51</span><span class=cl>
</span></span><span class=line><span class=ln> 52</span><span class=cl>  <span class=nd>@classmethod</span>
</span></span><span class=line><span class=ln> 53</span><span class=cl>  <span class=k>def</span> <span class=nf>_pack_ffmpeg_default</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>src</span><span class=p>,</span> <span class=n>dst</span><span class=p>,</span> <span class=n>seek</span><span class=p>,</span> <span class=n>duration</span><span class=p>,</span> <span class=n>asamplerate</span><span class=o>=</span><span class=mi>16000</span><span class=p>,</span> <span class=n>aformat</span><span class=o>=</span><span class=s1>&#39;ogg&#39;</span><span class=p>,</span> <span class=n>acodec</span><span class=o>=</span><span class=s1>&#39;libvorbis&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 54</span><span class=cl>    <span class=n>seek</span> <span class=o>=</span> <span class=bp>cls</span><span class=o>.</span><span class=n>_parse_seconds</span><span class=p>(</span><span class=n>seek</span><span class=p>)</span> <span class=k>if</span> <span class=n>seek</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=ln> 55</span><span class=cl>    <span class=n>duration</span> <span class=o>=</span> <span class=bp>cls</span><span class=o>.</span><span class=n>_parse_seconds</span><span class=p>(</span><span class=n>duration</span><span class=p>)</span> <span class=k>if</span> <span class=n>duration</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=ln> 56</span><span class=cl>    <span class=n>ffmpeg_args</span> <span class=o>=</span> <span class=nb>list</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 57</span><span class=cl>    <span class=n>ffmpeg_args</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=s1>&#39;-loglevel&#39;</span><span class=p>,</span> <span class=s1>&#39;warning&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=ln> 58</span><span class=cl>    <span class=n>ffmpeg_args</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=s1>&#39;-ss&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>seek</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=ln> 59</span><span class=cl>    <span class=k>if</span> <span class=n>src</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 60</span><span class=cl>      <span class=n>ffmpeg_args</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=s1>&#39;-i&#39;</span><span class=p>,</span> <span class=n>src</span><span class=p>])</span>
</span></span><span class=line><span class=ln> 61</span><span class=cl>    <span class=k>if</span> <span class=n>duration</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 62</span><span class=cl>      <span class=n>ffmpeg_args</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=s1>&#39;-t&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>duration</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=ln> 63</span><span class=cl>    <span class=k>if</span> <span class=n>aformat</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 64</span><span class=cl>      <span class=n>ffmpeg_args</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=s1>&#39;-f&#39;</span><span class=p>,</span> <span class=n>aformat</span><span class=p>])</span>
</span></span><span class=line><span class=ln> 65</span><span class=cl>    <span class=k>if</span> <span class=n>asamplerate</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 66</span><span class=cl>      <span class=n>ffmpeg_args</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=s1>&#39;-ar&#39;</span><span class=p>,</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>asamplerate</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=ln> 67</span><span class=cl>    <span class=k>if</span> <span class=n>acodec</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 68</span><span class=cl>      <span class=n>ffmpeg_args</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=s1>&#39;-c:a&#39;</span><span class=p>,</span> <span class=n>acodec</span><span class=p>])</span>
</span></span><span class=line><span class=ln> 69</span><span class=cl>    <span class=k>if</span> <span class=n>dst</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 70</span><span class=cl>      <span class=n>ffmpeg_args</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>dst</span> <span class=k>if</span> <span class=n>dst</span> <span class=o>!=</span> <span class=s1>&#39;-&#39;</span> <span class=k>else</span> <span class=s1>&#39;pipe:&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 71</span><span class=cl>    <span class=k>return</span> <span class=n>ffmpeg_args</span>
</span></span><span class=line><span class=ln> 72</span><span class=cl>
</span></span><span class=line><span class=ln> 73</span><span class=cl>  <span class=nd>@classmethod</span>
</span></span><span class=line><span class=ln> 74</span><span class=cl>  <span class=k>def</span> <span class=nf>ytdl_audio_partial</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>url</span><span class=p>,</span> <span class=n>dst</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>seek</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>asamplerate</span><span class=o>=</span><span class=mi>16000</span><span class=p>,</span> <span class=n>aformat</span><span class=o>=</span><span class=s1>&#39;ogg&#39;</span><span class=p>,</span> <span class=n>acodec</span><span class=o>=</span><span class=s1>&#39;libvorbis&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 75</span><span class=cl>    <span class=n>ffmpeg_args</span> <span class=o>=</span> <span class=bp>cls</span><span class=o>.</span><span class=n>_pack_ffmpeg_default</span><span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=kc>None</span><span class=p>,</span> <span class=n>seek</span><span class=p>,</span> <span class=n>duration</span><span class=p>,</span> <span class=n>asamplerate</span><span class=p>,</span> <span class=n>aformat</span><span class=p>,</span> <span class=n>acodec</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 76</span><span class=cl>    <span class=n>opts</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=ln> 77</span><span class=cl>    <span class=n>opts</span><span class=p>[</span><span class=s1>&#39;overwrites&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=ln> 78</span><span class=cl>    <span class=n>opts</span><span class=p>[</span><span class=s1>&#39;external_downloader&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;default&#39;</span><span class=p>:</span> <span class=s1>&#39;ffmpeg&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=ln> 79</span><span class=cl>    <span class=n>opts</span><span class=p>[</span><span class=s1>&#39;external_downloader_args&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;ffmpeg&#39;</span><span class=p>:</span> <span class=n>ffmpeg_args</span><span class=p>}</span>
</span></span><span class=line><span class=ln> 80</span><span class=cl>    <span class=n>opts</span><span class=p>[</span><span class=s1>&#39;postprocessors&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=ln> 81</span><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=ln> 82</span><span class=cl>        <span class=s1>&#39;key&#39;</span><span class=p>:</span> <span class=s1>&#39;FFmpegExtractAudio&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 83</span><span class=cl>        <span class=s1>&#39;nopostoverwrites&#39;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 84</span><span class=cl>        <span class=s1>&#39;preferredcodec&#39;</span><span class=p>:</span> <span class=s1>&#39;best&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 85</span><span class=cl>        <span class=s1>&#39;preferredquality&#39;</span><span class=p>:</span> <span class=s1>&#39;5&#39;</span>
</span></span><span class=line><span class=ln> 86</span><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=ln> 87</span><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=ln> 88</span><span class=cl>    <span class=k>if</span> <span class=n>dst</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 89</span><span class=cl>      <span class=n>opts</span><span class=p>[</span><span class=s1>&#39;outtmpl&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;default&#39;</span><span class=p>:</span> <span class=n>dst</span><span class=p>}</span>
</span></span><span class=line><span class=ln> 90</span><span class=cl>    <span class=k>with</span> <span class=n>YoutubeDL</span><span class=p>(</span><span class=n>opts</span><span class=p>)</span> <span class=k>as</span> <span class=n>ytdl</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 91</span><span class=cl>      <span class=k>return</span> <span class=n>ytdl</span><span class=o>.</span><span class=n>download</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 92</span><span class=cl>
</span></span><span class=line><span class=ln> 93</span><span class=cl>  <span class=nd>@classmethod</span>
</span></span><span class=line><span class=ln> 94</span><span class=cl>  <span class=k>def</span> <span class=nf>ffmpeg_audio_partial</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>src</span><span class=p>,</span> <span class=n>dst</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>seek</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>duration</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>asamplerate</span><span class=o>=</span><span class=mi>16000</span><span class=p>,</span> <span class=n>aformat</span><span class=o>=</span><span class=s1>&#39;ogg&#39;</span><span class=p>,</span> <span class=n>acodec</span><span class=o>=</span><span class=s1>&#39;libvorbis&#39;</span><span class=p>):</span> <span class=c1># 22050</span>
</span></span><span class=line><span class=ln> 95</span><span class=cl>    <span class=n>cmds</span> <span class=o>=</span> <span class=p>[</span><span class=bp>cls</span><span class=o>.</span><span class=n>exec_ffmpeg</span><span class=p>]</span>
</span></span><span class=line><span class=ln> 96</span><span class=cl>    <span class=n>ffmpeg_args</span> <span class=o>=</span> <span class=bp>cls</span><span class=o>.</span><span class=n>_pack_ffmpeg_default</span><span class=p>(</span><span class=n>src</span><span class=p>,</span> <span class=n>dst</span><span class=p>,</span> <span class=n>seek</span><span class=p>,</span> <span class=n>duration</span><span class=p>,</span> <span class=n>asamplerate</span><span class=p>,</span> <span class=n>aformat</span><span class=p>,</span> <span class=n>acodec</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 97</span><span class=cl>    <span class=n>cmds</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>ffmpeg_args</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 98</span><span class=cl>    <span class=n>pipe</span> <span class=o>=</span> <span class=n>subprocess</span><span class=o>.</span><span class=n>Popen</span><span class=p>(</span><span class=n>cmds</span><span class=p>,</span> <span class=n>stdout</span><span class=o>=</span><span class=n>subprocess</span><span class=o>.</span><span class=n>PIPE</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 99</span><span class=cl>    <span class=n>buf</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=ln>100</span><span class=cl>    <span class=n>size</span> <span class=o>=</span> <span class=mi>2</span><span class=o>**</span><span class=mi>12</span>
</span></span><span class=line><span class=ln>101</span><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=ln>102</span><span class=cl>      <span class=n>b</span> <span class=o>=</span> <span class=n>pipe</span><span class=o>.</span><span class=n>stdout</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=ln>103</span><span class=cl>      <span class=k>if</span> <span class=ow>not</span> <span class=n>b</span><span class=p>:</span> <span class=k>break</span>
</span></span><span class=line><span class=ln>104</span><span class=cl>      <span class=n>buf</span> <span class=o>+=</span> <span class=n>b</span>
</span></span><span class=line><span class=ln>105</span><span class=cl>    <span class=k>return</span> <span class=n>buf</span>
</span></span><span class=line><span class=ln>106</span><span class=cl>
</span></span><span class=line><span class=ln>107</span><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>recognize_from_file</span><span class=p>(</span><span class=n>shazam_client</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>seek</span><span class=p>,</span> <span class=n>duration</span><span class=p>,</span> <span class=n>asamplerate</span><span class=o>=</span><span class=mi>16000</span><span class=p>,</span> <span class=n>aformat</span><span class=o>=</span><span class=s1>&#39;ogg&#39;</span><span class=p>,</span> <span class=n>acodec</span><span class=o>=</span><span class=s1>&#39;libvorbis&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=ln>108</span><span class=cl>  <span class=n>buf</span> <span class=o>=</span> <span class=n>Shazamnnn</span><span class=o>.</span><span class=n>ffmpeg_audio_partial</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=n>seek</span><span class=p>,</span> <span class=n>duration</span><span class=p>,</span> <span class=n>asamplerate</span><span class=p>,</span> <span class=n>aformat</span><span class=p>,</span> <span class=n>acodec</span><span class=p>)</span>
</span></span><span class=line><span class=ln>109</span><span class=cl>  <span class=n>duration</span> <span class=o>=</span> <span class=n>Shazamnnn</span><span class=o>.</span><span class=n>_parse_seconds</span><span class=p>(</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=ln>110</span><span class=cl>  <span class=n>dat</span> <span class=o>=</span> <span class=k>await</span> <span class=n>shazam_client</span><span class=o>.</span><span class=n>recognize</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>options</span><span class=o>=</span><span class=n>SearchParams</span><span class=p>(</span><span class=n>segment_duration_seconds</span><span class=o>=</span><span class=n>duration</span><span class=p>))</span>
</span></span><span class=line><span class=ln>111</span><span class=cl>  <span class=k>return</span> <span class=n>dat</span>
</span></span><span class=line><span class=ln>112</span><span class=cl>
</span></span><span class=line><span class=ln>113</span><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>recognize_from_url</span><span class=p>(</span><span class=n>shazam_client</span><span class=p>,</span> <span class=n>url</span><span class=p>,</span> <span class=n>seek</span><span class=p>,</span> <span class=n>duration</span><span class=p>,</span> <span class=n>asamplerate</span><span class=o>=</span><span class=mi>16000</span><span class=p>,</span> <span class=n>aformat</span><span class=o>=</span><span class=s1>&#39;ogg&#39;</span><span class=p>,</span> <span class=n>acodec</span><span class=o>=</span><span class=s1>&#39;libvorbis&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=ln>114</span><span class=cl>  <span class=c1># ive tried various methods while avoiding subprocess </span>
</span></span><span class=line><span class=ln>115</span><span class=cl>  <span class=c1># for piping ytdl output into stdout but no success so far,</span>
</span></span><span class=line><span class=ln>116</span><span class=cl>  <span class=c1># thus tempfile it is</span>
</span></span><span class=line><span class=ln>117</span><span class=cl>  <span class=n>fd</span><span class=p>,</span> <span class=n>path</span> <span class=o>=</span> <span class=n>tempfile</span><span class=o>.</span><span class=n>mkstemp</span><span class=p>()</span>
</span></span><span class=line><span class=ln>118</span><span class=cl>  <span class=n>os</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>)</span>
</span></span><span class=line><span class=ln>119</span><span class=cl>  <span class=n>Shazamnnn</span><span class=o>.</span><span class=n>ytdl_audio_partial</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>path</span><span class=p>,</span> <span class=n>seek</span><span class=p>,</span> <span class=n>duration</span><span class=p>,</span> <span class=n>asamplerate</span><span class=p>,</span> <span class=n>aformat</span><span class=p>,</span> <span class=n>acodec</span><span class=p>)</span>
</span></span><span class=line><span class=ln>120</span><span class=cl>  <span class=n>buf</span> <span class=o>=</span> <span class=n>Shazamnnn</span><span class=o>.</span><span class=n>ffmpeg_audio_partial</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s1>&#39;-&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>duration</span><span class=p>,</span> <span class=n>asamplerate</span><span class=p>,</span> <span class=n>aformat</span><span class=p>,</span> <span class=n>acodec</span><span class=p>)</span>
</span></span><span class=line><span class=ln>121</span><span class=cl>  <span class=n>duration</span> <span class=o>=</span> <span class=n>Shazamnnn</span><span class=o>.</span><span class=n>_parse_seconds</span><span class=p>(</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=ln>122</span><span class=cl>  <span class=n>dat</span> <span class=o>=</span> <span class=k>await</span> <span class=n>shazam_client</span><span class=o>.</span><span class=n>recognize</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=n>options</span><span class=o>=</span><span class=n>SearchParams</span><span class=p>(</span><span class=n>segment_duration_seconds</span><span class=o>=</span><span class=n>duration</span><span class=p>))</span>
</span></span><span class=line><span class=ln>123</span><span class=cl>  <span class=n>os</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=ln>124</span><span class=cl>  <span class=k>return</span> <span class=n>dat</span>
</span></span><span class=line><span class=ln>125</span><span class=cl>
</span></span><span class=line><span class=ln>126</span><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=ln>127</span><span class=cl>  <span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=ln>128</span><span class=cl>  <span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=ln>129</span><span class=cl>  <span class=kn>from</span> <span class=nn>argparse</span> <span class=kn>import</span> <span class=n>ArgumentParser</span>
</span></span><span class=line><span class=ln>130</span><span class=cl>
</span></span><span class=line><span class=ln>131</span><span class=cl>  <span class=n>parser</span> <span class=o>=</span> <span class=n>ArgumentParser</span><span class=p>(</span><span class=s1>&#39;shazamnnnnn&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>132</span><span class=cl>  <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;source&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>133</span><span class=cl>  <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-s&#39;</span><span class=p>,</span> <span class=s1>&#39;--seek&#39;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s1>&#39;0&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>134</span><span class=cl>  <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span><span class=s1>&#39;-t&#39;</span><span class=p>,</span> <span class=s1>&#39;--duration&#39;</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=s1>&#39;10&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>135</span><span class=cl>
</span></span><span class=line><span class=ln>136</span><span class=cl>  <span class=n>args</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>()</span>
</span></span><span class=line><span class=ln>137</span><span class=cl>
</span></span><span class=line><span class=ln>138</span><span class=cl>  <span class=n>client</span> <span class=o>=</span> <span class=n>Shazam</span><span class=p>(</span>
</span></span><span class=line><span class=ln>139</span><span class=cl>    <span class=n>http_client</span><span class=o>=</span><span class=n>HTTPClient</span><span class=p>(</span>
</span></span><span class=line><span class=ln>140</span><span class=cl>      <span class=n>retry_options</span><span class=o>=</span><span class=n>ExponentialRetry</span><span class=p>(</span>
</span></span><span class=line><span class=ln>141</span><span class=cl>        <span class=n>attempts</span><span class=o>=</span><span class=mi>12</span><span class=p>,</span> <span class=n>max_timeout</span><span class=o>=</span><span class=mf>204.8</span><span class=p>,</span> <span class=n>statuses</span><span class=o>=</span><span class=p>{</span><span class=mi>500</span><span class=p>,</span> <span class=mi>502</span><span class=p>,</span> <span class=mi>503</span><span class=p>,</span> <span class=mi>504</span><span class=p>,</span> <span class=mi>429</span><span class=p>}</span>
</span></span><span class=line><span class=ln>142</span><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=ln>143</span><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=ln>144</span><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=ln>145</span><span class=cl>  
</span></span><span class=line><span class=ln>146</span><span class=cl>  <span class=n>coro</span> <span class=o>=</span> <span class=n>recognize_from_url</span> <span class=k>if</span> <span class=n>Shazamnnn</span><span class=o>.</span><span class=n>is_url</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>source</span><span class=p>)</span> <span class=k>else</span> <span class=n>recognize_from_file</span>
</span></span><span class=line><span class=ln>147</span><span class=cl>
</span></span><span class=line><span class=ln>148</span><span class=cl>  <span class=n>dat</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span></span><span class=line><span class=ln>149</span><span class=cl>    <span class=n>coro</span><span class=p>(</span>
</span></span><span class=line><span class=ln>150</span><span class=cl>      <span class=n>client</span><span class=p>,</span>
</span></span><span class=line><span class=ln>151</span><span class=cl>      <span class=n>args</span><span class=o>.</span><span class=n>source</span><span class=p>,</span>
</span></span><span class=line><span class=ln>152</span><span class=cl>      <span class=n>args</span><span class=o>.</span><span class=n>seek</span><span class=p>,</span>
</span></span><span class=line><span class=ln>153</span><span class=cl>      <span class=n>args</span><span class=o>.</span><span class=n>duration</span>
</span></span><span class=line><span class=ln>154</span><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=ln>155</span><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=ln>156</span><span class=cl>
</span></span><span class=line><span class=ln>157</span><span class=cl>  <span class=k>if</span> <span class=n>dat</span><span class=p>:</span> <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>dat</span><span class=p>,</span> <span class=n>sys</span><span class=o>.</span><span class=n>stdout</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></div></div><br><br><br><br><p class=tc>Built with <a a target=_blank class=extern href=https://gohugo.io/>Hugo</a> | previoip (c) 2025</p></body></html>