<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-8HTK24ZVY8"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8HTK24ZVY8",{anonymize_ip:!1})}</script><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel=stylesheet><link rel=stylesheet type=text/css href="/css/styles.css?v=0.1.3"><link rel=stylesheet href="/css/highlight.css?v=1.0.1"><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script src="/js/main.js?v=0.1.1" defer></script><title>Python Hijinks: Parsing OTF File &ndash; dumb by default</title></head><body><div id=navbar><ul class=nav-col><li class=nav-item><a class=nav-link href=/>Home</a></li><li class=nav-item><a class=nav-link href=/about/>About</a></li><li class=nav-item><a class=nav-link href=/posts/>Posts</a></li><li class=nav-item><a class=nav-link href=/resources/>Resources</a></li></ul></div><div class=wrapper><article><header><nav class=crumb><ol style=padding-left:0><li class=crumb><a href=/>Home</a></li><li class=crumb><a href=/posts/>Posts</a></li><li class="crumb active">Python Hijinks: Parsing OTF File</li></ol></nav><h1 class=header-title>Python Hijinks: Parsing OTF File</h1><pre style=margin:0>published-date: 26 Feb 2023 12:19 &#43;0700</pre><pre style=margin:0>categories: <a href=http://previoip.github.io/categories/you-tried/>you-tried</a> <a href=http://previoip.github.io/categories/python-hijinks/>python-hijinks</a></pre><pre style=margin:0>tags: <a href=http://previoip.github.io/tags/python/>python</a></pre></header><hr><p><img src=./images/you-tried.jpg alt="you tried"></p><p>Few days ago I stumbled upon a documentation for <a target=_blank class=extern href=https://learn.microsoft.com/en-us/typography/opentype/spec/otff>OTF font-file structure on learn.microsoft</a>. For some reason I remembered watching tsoding dialy stream on <a target=_blank class=extern href="https://www.youtube.com/watch?v=67FmRyv8jTM">Parsing Java Bytecode with Python</a> (highly recommended!) which leads me into this post.</p><p>Thus in the past few days, I&rsquo;ve been learning byte parsing with only python builtin library with my deadline being this week&rsquo;s weekend. Suffice to say though, it&rsquo;s still far from being usable. But the output of parsed table (at least for me) is always satisfying to read.</p><p>You can view the source code <a target=_blank class=extern href="https://colab.research.google.com/drive/1fTmHNqr13vbJ4yGwjjPjz2Fm50npKFOA?usp=sharing">here (colab)</a>. I tried my best to keep the notebook as concise as possible, by showing my way on brainstorming the steps required to do this task.</p><p>Feel free to copy and modify the colab notebook I linked above. The source code is under <a target=_blank class=extern href=https://unlicense.org/>Unlicense</a>.</p><p>There are few things to note:</p><h1 id=choosing-a-font-from-fontsgoogle>Choosing a font from fonts.google</h1><p>Inside the notebook, font file is downloaded directly from <a target=_blank class=extern href=https://fonts.google.com/>fonts.google</a>. In theory you can parse any Open Type Font that is available on the internet. But if you want to download the font like in the snippet, then you&rsquo;d have to replace <code>fpath</code> font filename and <code>furl</code> query argument <code>?family=...</code> to match your target font from fonts.google.com.</p><p>To obtain the url or the url argument, you can download <em><strong>one</strong></em> font and immediately press escape to get the download url. If the url does not appear on the address bar, Developer Tools can be used to fetch the get request on the page.</p><p>Here&rsquo;s a step-by-step guide.</p><p><img src=images/fonts-google-downloading%20a%20font.png alt=fonts-google-downloading-a-font></p><p>Once you&rsquo;ve selected the family, and click download all button, you&rsquo;ll be redirected to a blank screen. Once you&rsquo;re there, hit <code>esc</code> before your browser closes the tab.</p><p><img src=images/fonts-google-empty-screen.png alt=fonts-google-blank></p><p>If your browser address bar is empty or only shows <code>about:blank</code>, fret not! hit f12 (assuming you&rsquo;re using firefox) and navigate through the Developer Tools into the Network tab.</p><p><img src=images/fonts-google-developer-tools.png alt=developer-tools></p><p>Which would look like the following figure.</p><p><img src=images/fonts-google-developer-tools-network-tab.png alt=developer-tools-network-tab></p><p>Now you&rsquo;d need to reload once again and hit escape to see the request that went trough that page.</p><p><img src=images/fonts-google-developer-tools-network-tab-get-request.png alt=developer-tools-get-request></p><p>And now you can copy-paste the url onto the <code>flink</code> variable on the notebook. Don&rsquo;t forget to change the <code>fpath</code> as well.</p><h1 id=limitation-and-over-engineering-side-of-the-notebook>Limitation and Over-engineering side of the notebook</h1><p>This colab notebook was only used as an exercise. The main focus was implementing required tables from the spec documentation. There are a lot of tables that is required and is fairly complex to parse. Take a look at <code>cmap</code> table and you&rsquo;ll see barely half of the spec is implemented.</p><p>There are also a redundant functionality of the notebook where I foresaw I&rsquo;d need to account <code>total_parsed_size</code> in bytes to make sure all the TableRecord length are fulfilled. But this turns out to be a hassle.</p><p>Function parameters from parsing tables are also differs from one to the other. Which cause a bit of confusion initially on what goes where and why.</p><p>One thing I over-engineer the most was the <code>Container</code> class which was built so I can assign attribute dynamically, but is not a standard way to store parsed values as a structured object. One reason I used this to contain all parsed values is the custom <code>__repr__</code> class model method where I can just directly put any instance in <code>print()</code> to see all the structure.</p><p>It also acts like linked list thus (initially) it has the ability traverse between table nodes. But this, again, turns out to be a huge hassle since it assigns parent node by the end of the parsing process.</p><p>But I like it. so here&rsquo;s the whole snippet of <code>Container</code> class.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Container</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ID</span><span class=o>=</span><span class=s1>&#39;Unassigned&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>ID</span> <span class=o>=</span> <span class=n>ID</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>_dict</span> <span class=o>=</span> <span class=n>OrderedDict</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>_parentNode</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>_reserved</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>dir</span><span class=p>(</span><span class=bp>self</span><span class=p>))</span> <span class=o>+</span> <span class=p>[</span><span class=s1>&#39;_reserved&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>put</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>_dict</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=p>):</span>
</span></span><span class=line><span class=cl>      <span class=n>value</span><span class=o>.</span><span class=n>_parentNode</span> <span class=o>=</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=p>(</span><span class=nb>list</span><span class=p>,</span> <span class=nb>tuple</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>value</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=p>):</span>
</span></span><span class=line><span class=cl>          <span class=n>i</span><span class=o>.</span><span class=n>_parentNode</span> <span class=o>=</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>get_parent_node</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_parentNode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;=v= </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>ID</span><span class=si>}</span><span class=s1> =v=</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>l</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=nb>len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_dict</span><span class=o>.</span><span class=n>keys</span><span class=p>()),</span> <span class=n>default</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># scare the hoes</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_dict</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
</span></span><span class=line><span class=cl>      <span class=n>s</span> <span class=o>+=</span> <span class=n>padstr</span><span class=p>(</span><span class=n>k</span><span class=p>,</span> <span class=n>l</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>s</span> <span class=o>+=</span> <span class=s1>&#39; : &#39;</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=n>item</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_dict</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=n>item</span> <span class=o>==</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>+=</span> <span class=s1>&#39;null&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>elif</span> <span class=n>k</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;_data&#39;</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>type</span><span class=p>(</span><span class=n>item</span><span class=p>)</span> <span class=o>==</span> <span class=s1>&#39;bytes&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>+=</span> <span class=s1>&#39;[Blob]&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>  &#39;</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>  &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>item</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=p>(</span><span class=nb>list</span><span class=p>,</span> <span class=nb>tuple</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>item</span><span class=p>:</span>
</span></span><span class=line><span class=cl>          <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>item</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=vm>__class__</span><span class=p>):</span>
</span></span><span class=line><span class=cl>          <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>╤&#39;</span> <span class=o>+</span> <span class=s1>&#39;═&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=n>l</span> <span class=o>+</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=n>_item_l</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=n>_item_r</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>item</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>40</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>_item_l</span> <span class=o>=</span> <span class=n>item</span><span class=p>[:</span><span class=mi>15</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>_item_r</span> <span class=o>=</span> <span class=n>item</span><span class=p>[</span><span class=o>-</span><span class=mi>15</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>for</span> <span class=n>subitem</span> <span class=ow>in</span> <span class=n>_item_l</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>├───╢ &#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>│     &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>subitem</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=n>_item_r</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>┴&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>░&#39;</span> <span class=o>+</span> <span class=s1>&#39; &#39;</span> <span class=o>*</span> <span class=p>(</span><span class=n>l</span> <span class=o>+</span> <span class=mi>3</span><span class=p>)</span> <span class=o>+</span> <span class=sa>f</span><span class=s1>&#39;... (truncated </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>item</span><span class=p>)</span><span class=o>-</span><span class=mi>30</span><span class=si>}</span><span class=s1> entries)&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>┬&#39;</span>
</span></span><span class=line><span class=cl>            <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>│&#39;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>subitem</span> <span class=ow>in</span> <span class=n>_item_r</span><span class=p>:</span>
</span></span><span class=line><span class=cl>              <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>├───╢ &#39;</span>
</span></span><span class=line><span class=cl>              <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>│     &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>subitem</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>          <span class=n>_temp_item</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>_temp_item</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>_temp_item</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>_temp_item</span><span class=p>[:</span><span class=mi>10</span><span class=p>])[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=s1>&#39;, ... , &#39;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>(</span><span class=n>_temp_item</span><span class=p>[</span><span class=o>-</span><span class=mi>10</span><span class=p>:])[</span><span class=mi>1</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>          <span class=n>s</span> <span class=o>+=</span> <span class=nb>str</span><span class=p>(</span><span class=n>_temp_item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>s</span> <span class=o>+=</span> <span class=nb>str</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=n>s</span> <span class=o>+=</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>s</span> <span class=o>+=</span> <span class=sa>f</span><span class=s1>&#39;=^= </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>ID</span><span class=si>}</span><span class=s1> =^=</span><span class=se>\n</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=fm>__getattr__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>__name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>__name</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_dict</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>__name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>object</span><span class=o>.</span><span class=fm>__getattribute__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>__name</span><span class=p>)</span>
</span></span></code></pre></div><p>wack.</p></article><div class=posts></div></ul></div><div id=footer><div style=display:flex;justify-content:center><small>Built with <a a target=_blank class=extern href=https://gohugo.io/>Hugo</a> | previoip &copy;2022</small></div></div></body></html>