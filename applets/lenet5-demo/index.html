<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-8HTK24ZVY8"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8HTK24ZVY8")}</script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=description content><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href="/css/highlight.css?v=1.0.0"><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><style>:root{--f:1em;--w:30}html{margin:0 2em;max-width:calc(var(--f)*var(--w));font-size:var(--f)}body{margin:0;padding:0;font-family:monospace;scrollbar-face-color:ThreeDFace!important;scrollbar-shadow-color:ThreeDDarkShadow!important;scrollbar-highlight-color:ThreeDHighlight!important;scrollbar-3dlight-color:ThreeDLightShadow!important;scrollbar-darkshadow-color:ThreeDDarkShadow!important;scrollbar-track-color:Scrollbar!important;scrollbar-arrow-color:ButtonText!important}small{font-size:calc(var(--f)*.82)}*{font-size:inherit}p{padding-left:calc(var(--f)*1.6)}p canvas{outline:1px solid #000;width:calc(100% - var(--f)*1.6)}a{color:#1c69e5;text-decoration:underline}a:hover{color:#2072f5;text-decoration:none}a:active{color:#0062ff;text-decoration:none;background-color:var(--tx-c-hover)}blockquote{opacity:.75;background-color:#e9e61c68}div.mermaid .edgeLabel{padding:.2rem}img,div.mermaid svg{margin:auto;display:block;max-width:min(100%,calc(var(--f)*var(--w)));min-width:100px;background-color:#282a36;border-radius:.6rem}code:not([class]){background-color:#8e98d575;padding:0 .2em;border-radius:.2em}div.highlight pre{padding:1rem;border-radius:.6rem;overflow:scroll;overflow-y:auto;overflow-x:auto}div.highlight pre code span{margin-block-end:.1em}.disabled,.failed{pointer-events:none}.tc{padding-left:0;padding-right:0;text-align:center}.o50{opacity:.5}::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:#43454ce6;border-radius:3px}::-webkit-scrollbar-thumb{background:#c1cdf6e6;border-radius:3px}input,select{font:inherit}#control div{display:flex;align-items:center;margin-top:.6em}#control input,#control select{display:inline-block;margin:0 .5em}#control p{margin:0;width:2rem}</style><title>LeNet5 demo &ndash; dumb by default</title></head><body><div style=background-color:#69696969><br><h1 class=tc>dumb by default</h1><nav class=tc>[<a href=/>Home</a>]&nbsp;[<a href=/about/>About</a>]&nbsp;[<a href=/posts/>Posts</a>]&nbsp;[<a href=/resources/>Resources</a>]&nbsp;[<a href=/applets/>Applets</a>]&nbsp;</nav><hr></div><p style=padding:0><span>dir: <i><a href=/>Home</a> /
<a href=/applets/>Applets</a> /
<span>LeNet5 demo</span></i></span><br><span>published-date: 31 May 2025 14:25 +0700</span><br></p><h1 class=tc>LeNet5 demo</h1><hr><div><p>LeNet5 is one of few small image (to number) classification model. So small that this were made because of that. No more than 600 SLOC, all runs on cpu.</p><p>This model were trained using the following
<a target=_blank class=extern href="https://colab.research.google.com/drive/11FOgiU4c8GauvdZZNa5B0bzL1g8beBnO?usp=sharing">colab notebook</a> that i wrote which exports layers weight and bias as json for easy import. Weight is stored locally and can be accessed in the following <a href=./assets/LeNet5.json>link</a> (1.34MB).</p><p>Try it out yourself by drawing a number in the following canvas, then scroll down to see model inference result.</p><p>Note: does not perform well inferring the number 8, and distinguishing 1 and 7.</p><div id=control><input id=appInCanvasReset type=button value=clear></div><p><canvas id=Input width=512 height=512 style="outline:3px solid red!important;touch-action:none"></canvas></p><h1 id=output class=tc><br>output</h1><p><canvas id=Viewport width=1080 height=1920></canvas></p><div class=highlight inject=true><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln>  1</span><span class=cl><span class=nb>window</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span>
</span></span><span class=line><span class=ln>  2</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln>  3</span><span class=cl>
</span></span><span class=line><span class=ln>  4</span><span class=cl><span class=kr>const</span> <span class=nx>cvIn</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;Input&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>  5</span><span class=cl><span class=kr>const</span> <span class=nx>cvInCtx</span> <span class=o>=</span> <span class=nx>cvIn</span><span class=p>.</span><span class=nx>getContext</span><span class=p>(</span><span class=s2>&#34;2d&#34;</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;alpha&#34;</span><span class=o>:</span><span class=kc>false</span><span class=p>});</span>
</span></span><span class=line><span class=ln>  6</span><span class=cl><span class=kr>const</span> <span class=nx>cvPt</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;Viewport&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>  7</span><span class=cl><span class=kr>const</span> <span class=nx>cvPtCtx</span> <span class=o>=</span> <span class=nx>cvPt</span><span class=p>.</span><span class=nx>getContext</span><span class=p>(</span><span class=s2>&#34;2d&#34;</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;alpha&#34;</span><span class=o>:</span><span class=kc>false</span><span class=p>});</span>
</span></span><span class=line><span class=ln>  8</span><span class=cl><span class=kr>const</span> <span class=nx>ftoi</span> <span class=o>=</span> <span class=p>(</span><span class=nx>v</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=o>~~</span><span class=nx>v</span><span class=p>;</span>
</span></span><span class=line><span class=ln>  9</span><span class=cl><span class=kd>var</span> <span class=nx>cursorHandler</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 10</span><span class=cl><span class=kd>var</span> <span class=nx>data</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 11</span><span class=cl>
</span></span><span class=line><span class=ln> 12</span><span class=cl>
</span></span><span class=line><span class=ln> 13</span><span class=cl><span class=cm>/*  cursor handler:
</span></span></span><span class=line><span class=ln> 14</span><span class=cl><span class=cm>    tracks monitor and handle mouse/cursor events
</span></span></span><span class=line><span class=ln> 15</span><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=ln> 16</span><span class=cl>
</span></span><span class=line><span class=ln> 17</span><span class=cl><span class=kr>class</span> <span class=nx>cCursorHandler</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 18</span><span class=cl>  <span class=nx>flags</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;idle&#39;</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;move&#39;</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;down&#39;</span><span class=o>:</span> <span class=mi>2</span><span class=p>};</span>
</span></span><span class=line><span class=ln> 19</span><span class=cl>  <span class=nx>constructor</span> <span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>cb</span><span class=o>=</span><span class=p>(</span><span class=nx>event</span><span class=p>)=&gt;{})</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 20</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>el</span> <span class=o>=</span> <span class=nx>el</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 21</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>cb</span> <span class=o>=</span> <span class=nx>cb</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 22</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>w</span> <span class=o>=</span> <span class=nx>el</span><span class=p>.</span><span class=nx>width</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 23</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>h</span> <span class=o>=</span> <span class=nx>el</span><span class=p>.</span><span class=nx>height</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 24</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>flag</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>flags</span><span class=p>.</span><span class=nx>idle</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 25</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>pos</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln> 26</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>curr</span> <span class=o>=</span> <span class=p>{</span><span class=nx>x</span><span class=o>:</span><span class=mi>0</span><span class=p>,</span> <span class=nx>y</span><span class=o>:</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=ln> 27</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>prev</span> <span class=o>=</span> <span class=p>{</span><span class=nx>x</span><span class=o>:</span><span class=mi>0</span><span class=p>,</span> <span class=nx>y</span><span class=o>:</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=ln> 28</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>ratio</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln> 29</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>ratio</span><span class=p>.</span><span class=nx>curr</span> <span class=o>=</span> <span class=p>{</span><span class=nx>x</span><span class=o>:</span><span class=mi>0</span><span class=p>,</span> <span class=nx>y</span><span class=o>:</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=ln> 30</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>ratio</span><span class=p>.</span><span class=nx>prev</span> <span class=o>=</span> <span class=p>{</span><span class=nx>x</span><span class=o>:</span><span class=mi>0</span><span class=p>,</span> <span class=nx>y</span><span class=o>:</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=ln> 31</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>handleMove</span>  <span class=o>=</span> <span class=p>(</span><span class=nx>event</span><span class=p>)=&gt;{</span><span class=k>this</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span> <span class=k>this</span><span class=p>.</span><span class=nx>flag</span><span class=o>|=</span><span class=k>this</span><span class=p>.</span><span class=nx>flags</span><span class=p>.</span><span class=nx>move</span><span class=p>;</span> <span class=k>this</span><span class=p>.</span><span class=nx>cb</span><span class=p>(</span><span class=k>this</span><span class=p>)};</span>
</span></span><span class=line><span class=ln> 32</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>handleDown</span>  <span class=o>=</span> <span class=p>(</span><span class=nx>event</span><span class=p>)=&gt;{</span><span class=k>this</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span> <span class=k>this</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span> <span class=k>this</span><span class=p>.</span><span class=nx>flag</span><span class=o>|=</span><span class=k>this</span><span class=p>.</span><span class=nx>flags</span><span class=p>.</span><span class=nx>down</span><span class=p>;</span> <span class=k>this</span><span class=p>.</span><span class=nx>cb</span><span class=p>(</span><span class=k>this</span><span class=p>)};</span>
</span></span><span class=line><span class=ln> 33</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>handleUp</span>    <span class=o>=</span> <span class=p>(</span><span class=nx>event</span><span class=p>)=&gt;{</span><span class=k>this</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=nx>event</span><span class=p>);</span> <span class=k>this</span><span class=p>.</span><span class=nx>flag</span><span class=o>=</span><span class=k>this</span><span class=p>.</span><span class=nx>flags</span><span class=p>.</span><span class=nx>idle</span><span class=p>;</span>  <span class=k>this</span><span class=p>.</span><span class=nx>cb</span><span class=p>(</span><span class=k>this</span><span class=p>);};</span>
</span></span><span class=line><span class=ln> 34</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;pointermove&#34;</span><span class=p>,</span>   <span class=k>this</span><span class=p>.</span><span class=nx>handleMove</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 35</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;pointerdown&#34;</span><span class=p>,</span>   <span class=k>this</span><span class=p>.</span><span class=nx>handleDown</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 36</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;pointerup&#34;</span><span class=p>,</span>     <span class=k>this</span><span class=p>.</span><span class=nx>handleUp</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 37</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;pointercancel&#34;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>handleUp</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 38</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln> 39</span><span class=cl>  <span class=nx>update</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 40</span><span class=cl>    <span class=kd>let</span> <span class=nx>bcr</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>getBoundingClientRect</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 41</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>prev</span><span class=p>.</span><span class=nx>x</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>x</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 42</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>prev</span><span class=p>.</span><span class=nx>y</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>y</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 43</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>ratio</span><span class=p>.</span><span class=nx>prev</span><span class=p>.</span><span class=nx>x</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>ratio</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>x</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 44</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>ratio</span><span class=p>.</span><span class=nx>prev</span><span class=p>.</span><span class=nx>y</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>ratio</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>y</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 45</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>ratio</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>x</span> <span class=o>=</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>clientX</span> <span class=o>-</span> <span class=nx>bcr</span><span class=p>.</span><span class=nx>left</span><span class=p>)</span> <span class=o>/</span> <span class=nx>bcr</span><span class=p>.</span><span class=nx>width</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 46</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>ratio</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>y</span> <span class=o>=</span> <span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>clientY</span> <span class=o>-</span> <span class=nx>bcr</span><span class=p>.</span><span class=nx>top</span><span class=p>)</span> <span class=o>/</span> <span class=nx>bcr</span><span class=p>.</span><span class=nx>height</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 47</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>x</span> <span class=o>=</span> <span class=nx>ftoi</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>ratio</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>x</span> <span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>w</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 48</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>y</span> <span class=o>=</span> <span class=nx>ftoi</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>ratio</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>y</span> <span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>h</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 49</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln> 50</span><span class=cl>  <span class=nx>detach</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 51</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>removeEventListener</span><span class=p>(</span><span class=s2>&#34;pointermove&#34;</span><span class=p>,</span>   <span class=k>this</span><span class=p>.</span><span class=nx>handleMove</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 52</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>removeEventListener</span><span class=p>(</span><span class=s2>&#34;pointerdown&#34;</span><span class=p>,</span>   <span class=k>this</span><span class=p>.</span><span class=nx>handleDown</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 53</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>removeEventListener</span><span class=p>(</span><span class=s2>&#34;pointerup&#34;</span><span class=p>,</span>     <span class=k>this</span><span class=p>.</span><span class=nx>handleUp</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 54</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>el</span><span class=p>.</span><span class=nx>removeEventListener</span><span class=p>(</span><span class=s2>&#34;pointercancel&#34;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>handleUp</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 55</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln> 56</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 57</span><span class=cl>
</span></span><span class=line><span class=ln> 58</span><span class=cl>
</span></span><span class=line><span class=ln> 59</span><span class=cl><span class=cm>/*  Interp
</span></span></span><span class=line><span class=ln> 60</span><span class=cl><span class=cm>    namespace for interpolation methods
</span></span></span><span class=line><span class=ln> 61</span><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=ln> 62</span><span class=cl>
</span></span><span class=line><span class=ln> 63</span><span class=cl><span class=kr>class</span> <span class=nx>Interp</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 64</span><span class=cl>
</span></span><span class=line><span class=ln> 65</span><span class=cl>  <span class=kr>static</span> <span class=nx>bi_loop</span><span class=p>(</span><span class=nx>aw</span><span class=p>,</span> <span class=nx>ah</span><span class=p>,</span> <span class=nx>bw</span><span class=p>,</span> <span class=nx>bh</span><span class=p>,</span> <span class=nx>cb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 66</span><span class=cl>    <span class=kd>let</span> <span class=nx>cx</span><span class=p>,</span> <span class=nx>cy</span><span class=p>,</span> <span class=nx>rx</span><span class=p>,</span> <span class=nx>ry</span><span class=p>,</span> <span class=nx>ax</span><span class=p>,</span> <span class=nx>ay</span><span class=p>,</span> <span class=nx>bx</span><span class=p>,</span> <span class=nx>by</span><span class=p>,</span> <span class=nx>axl</span><span class=p>,</span> <span class=nx>axh</span><span class=p>,</span> <span class=nx>ayl</span><span class=p>,</span> <span class=nx>ayh</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 67</span><span class=cl>    <span class=nx>rx</span> <span class=o>=</span> <span class=p>(</span><span class=nx>aw</span><span class=o>-</span><span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=nx>bw</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 68</span><span class=cl>    <span class=nx>ry</span> <span class=o>=</span> <span class=p>(</span><span class=nx>ah</span><span class=o>-</span><span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=nx>bh</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 69</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=nx>bx</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>bx</span><span class=o>&lt;</span><span class=nx>bw</span><span class=p>;</span> <span class=nx>bx</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 70</span><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=nx>by</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>by</span><span class=o>&lt;</span><span class=nx>bh</span><span class=p>;</span> <span class=nx>by</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 71</span><span class=cl>        <span class=nx>axl</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>floor</span><span class=p>(</span><span class=nx>rx</span> <span class=o>*</span> <span class=nx>bx</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 72</span><span class=cl>        <span class=nx>axh</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>ceil</span> <span class=p>(</span><span class=nx>rx</span> <span class=o>*</span> <span class=nx>bx</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 73</span><span class=cl>        <span class=nx>ayl</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>floor</span><span class=p>(</span><span class=nx>ry</span> <span class=o>*</span> <span class=nx>by</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 74</span><span class=cl>        <span class=nx>ayh</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>ceil</span> <span class=p>(</span><span class=nx>ry</span> <span class=o>*</span> <span class=nx>by</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 75</span><span class=cl>        <span class=nx>cb</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 76</span><span class=cl>          <span class=nx>bx</span><span class=p>,</span> <span class=nx>by</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 77</span><span class=cl>          <span class=nx>axl</span><span class=p>,</span> <span class=nx>axh</span><span class=p>,</span> <span class=nx>ayl</span><span class=p>,</span> <span class=nx>ayh</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 78</span><span class=cl>          <span class=nx>rx</span><span class=o>*</span><span class=nx>bx</span><span class=o>-</span><span class=nx>axl</span><span class=p>,</span> <span class=nx>ry</span><span class=o>*</span><span class=nx>by</span><span class=o>-</span><span class=nx>ayl</span>
</span></span><span class=line><span class=ln> 79</span><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=ln> 80</span><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=ln> 81</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 82</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln> 83</span><span class=cl>
</span></span><span class=line><span class=ln> 84</span><span class=cl>  <span class=kr>static</span> <span class=nx>bi_invoke</span><span class=p>(</span><span class=nx>ms</span><span class=p>,</span> <span class=nx>md</span><span class=p>,</span> <span class=nx>bi_method</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 85</span><span class=cl>    <span class=nx>Interp</span><span class=p>.</span><span class=nx>bi_loop</span><span class=p>(</span><span class=nx>ms</span><span class=p>.</span><span class=nx>w</span><span class=p>,</span> <span class=nx>ms</span><span class=p>.</span><span class=nx>h</span><span class=p>,</span> <span class=nx>md</span><span class=p>.</span><span class=nx>w</span><span class=p>,</span> <span class=nx>md</span><span class=p>.</span><span class=nx>h</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 86</span><span class=cl>      <span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>,</span> <span class=nx>xl</span><span class=p>,</span> <span class=nx>xh</span><span class=p>,</span> <span class=nx>yl</span><span class=p>,</span> <span class=nx>yh</span><span class=p>,</span> <span class=nx>xt</span><span class=p>,</span> <span class=nx>yt</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=ln> 87</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>x</span><span class=o>&lt;</span><span class=mi>0</span> <span class=o>||</span> <span class=nx>x</span><span class=o>&gt;=</span><span class=nx>md</span><span class=p>.</span><span class=nx>w</span> <span class=o>||</span> <span class=nx>y</span><span class=o>&lt;</span><span class=mi>0</span> <span class=o>||</span> <span class=nx>y</span><span class=o>&gt;=</span><span class=nx>md</span><span class=p>.</span><span class=nx>h</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 88</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>xl</span><span class=o>&lt;</span><span class=mi>0</span> <span class=o>||</span> <span class=nx>xl</span><span class=o>&gt;=</span><span class=nx>ms</span><span class=p>.</span><span class=nx>w</span> <span class=o>||</span> <span class=nx>yl</span><span class=o>&lt;</span><span class=mi>0</span> <span class=o>||</span> <span class=nx>yl</span><span class=o>&gt;=</span><span class=nx>ms</span><span class=p>.</span><span class=nx>h</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 89</span><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>xh</span><span class=o>&lt;</span><span class=mi>0</span> <span class=o>||</span> <span class=nx>xh</span><span class=o>&gt;=</span><span class=nx>ms</span><span class=p>.</span><span class=nx>w</span> <span class=o>||</span> <span class=nx>yh</span><span class=o>&lt;</span><span class=mi>0</span> <span class=o>||</span> <span class=nx>yh</span><span class=o>&gt;=</span><span class=nx>ms</span><span class=p>.</span><span class=nx>h</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 90</span><span class=cl>        <span class=nx>md</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>,</span> <span class=nx>bi_method</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 91</span><span class=cl>          <span class=nx>ms</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>xl</span><span class=p>,</span> <span class=nx>yl</span><span class=p>),</span> <span class=nx>ms</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>xh</span><span class=p>,</span> <span class=nx>yl</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 92</span><span class=cl>          <span class=nx>ms</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>xl</span><span class=p>,</span> <span class=nx>yh</span><span class=p>),</span> <span class=nx>ms</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>xh</span><span class=p>,</span> <span class=nx>yh</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 93</span><span class=cl>          <span class=nx>xt</span><span class=p>,</span> <span class=nx>yt</span>
</span></span><span class=line><span class=ln> 94</span><span class=cl>        <span class=p>));</span>
</span></span><span class=line><span class=ln> 95</span><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=ln> 96</span><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=ln> 97</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln> 98</span><span class=cl>
</span></span><span class=line><span class=ln> 99</span><span class=cl>  <span class=kr>static</span> <span class=nx>nearest</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>,</span> <span class=nx>t</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>100</span><span class=cl>    <span class=k>return</span> <span class=nx>t</span> <span class=o>&gt;=</span> <span class=p>.</span><span class=mi>5</span> <span class=o>?</span> <span class=nx>b</span> <span class=o>:</span> <span class=nx>a</span><span class=p>;</span>
</span></span><span class=line><span class=ln>101</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>102</span><span class=cl>
</span></span><span class=line><span class=ln>103</span><span class=cl>  <span class=kr>static</span> <span class=nx>binearest</span><span class=p>(</span><span class=nx>a1</span><span class=p>,</span> <span class=nx>b1</span><span class=p>,</span> <span class=nx>a2</span><span class=p>,</span> <span class=nx>b2</span><span class=p>,</span> <span class=nx>t1</span><span class=p>,</span> <span class=nx>t2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>104</span><span class=cl>    <span class=k>return</span> <span class=nx>Interp</span><span class=p>.</span><span class=nx>nearest</span><span class=p>(</span>
</span></span><span class=line><span class=ln>105</span><span class=cl>      <span class=nx>Interp</span><span class=p>.</span><span class=nx>nearest</span><span class=p>(</span><span class=nx>a1</span><span class=p>,</span> <span class=nx>b1</span><span class=p>,</span> <span class=nx>t1</span><span class=p>),</span>
</span></span><span class=line><span class=ln>106</span><span class=cl>      <span class=nx>Interp</span><span class=p>.</span><span class=nx>nearest</span><span class=p>(</span><span class=nx>a2</span><span class=p>,</span> <span class=nx>b2</span><span class=p>,</span> <span class=nx>t1</span><span class=p>),</span>
</span></span><span class=line><span class=ln>107</span><span class=cl>      <span class=nx>t2</span>
</span></span><span class=line><span class=ln>108</span><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=ln>109</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>110</span><span class=cl>
</span></span><span class=line><span class=ln>111</span><span class=cl>  <span class=kr>static</span> <span class=nx>binearest_m</span><span class=p>(</span><span class=nx>ms</span><span class=p>,</span> <span class=nx>md</span><span class=p>)</span> <span class=p>{</span><span class=nx>Interp</span><span class=p>.</span><span class=nx>bi_invoke</span><span class=p>(</span><span class=nx>ms</span><span class=p>,</span> <span class=nx>md</span><span class=p>,</span> <span class=nx>Interp</span><span class=p>.</span><span class=nx>binearest</span><span class=p>);}</span>
</span></span><span class=line><span class=ln>112</span><span class=cl>
</span></span><span class=line><span class=ln>113</span><span class=cl>  <span class=kr>static</span> <span class=nx>linear</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>,</span> <span class=nx>t</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>114</span><span class=cl>    <span class=k>return</span> <span class=nx>a</span> <span class=o>+</span> <span class=p>(</span><span class=nx>b</span> <span class=o>-</span> <span class=nx>a</span><span class=p>)</span> <span class=o>*</span> <span class=nx>t</span>
</span></span><span class=line><span class=ln>115</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>116</span><span class=cl>
</span></span><span class=line><span class=ln>117</span><span class=cl>  <span class=kr>static</span> <span class=nx>bilinear</span><span class=p>(</span><span class=nx>a1</span><span class=p>,</span> <span class=nx>b1</span><span class=p>,</span> <span class=nx>a2</span><span class=p>,</span> <span class=nx>b2</span><span class=p>,</span> <span class=nx>t1</span><span class=p>,</span> <span class=nx>t2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>118</span><span class=cl>    <span class=k>return</span> <span class=nx>Interp</span><span class=p>.</span><span class=nx>linear</span><span class=p>(</span>
</span></span><span class=line><span class=ln>119</span><span class=cl>      <span class=nx>Interp</span><span class=p>.</span><span class=nx>linear</span><span class=p>(</span><span class=nx>a1</span><span class=p>,</span> <span class=nx>b1</span><span class=p>,</span> <span class=nx>t1</span><span class=p>),</span>
</span></span><span class=line><span class=ln>120</span><span class=cl>      <span class=nx>Interp</span><span class=p>.</span><span class=nx>linear</span><span class=p>(</span><span class=nx>a2</span><span class=p>,</span> <span class=nx>b2</span><span class=p>,</span> <span class=nx>t1</span><span class=p>),</span>
</span></span><span class=line><span class=ln>121</span><span class=cl>      <span class=nx>t2</span>
</span></span><span class=line><span class=ln>122</span><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=ln>123</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>124</span><span class=cl>
</span></span><span class=line><span class=ln>125</span><span class=cl>  <span class=kr>static</span> <span class=nx>bilinear_m</span><span class=p>(</span><span class=nx>ms</span><span class=p>,</span> <span class=nx>md</span><span class=p>)</span> <span class=p>{</span><span class=nx>Interp</span><span class=p>.</span><span class=nx>bi_invoke</span><span class=p>(</span><span class=nx>ms</span><span class=p>,</span> <span class=nx>md</span><span class=p>,</span> <span class=nx>Interp</span><span class=p>.</span><span class=nx>bilinear</span><span class=p>)}</span>
</span></span><span class=line><span class=ln>126</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>127</span><span class=cl>
</span></span><span class=line><span class=ln>128</span><span class=cl>
</span></span><span class=line><span class=ln>129</span><span class=cl><span class=cm>/*  ==================== CNN Stuffs ==================== */</span>
</span></span><span class=line><span class=ln>130</span><span class=cl>
</span></span><span class=line><span class=ln>131</span><span class=cl><span class=cm>/*  Float32Matrix
</span></span></span><span class=line><span class=ln>132</span><span class=cl><span class=cm>    butchered 2d matrix implementation
</span></span></span><span class=line><span class=ln>133</span><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=ln>134</span><span class=cl>
</span></span><span class=line><span class=ln>135</span><span class=cl><span class=kr>class</span> <span class=nx>cFloat32Matrix</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>136</span><span class=cl>  <span class=nx>constructor</span> <span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>h</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>137</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>w</span> <span class=o>=</span> <span class=nx>w</span><span class=p>;</span> <span class=k>this</span><span class=p>.</span><span class=nx>h</span> <span class=o>=</span> <span class=nx>h</span><span class=p>;</span> <span class=k>this</span><span class=p>.</span><span class=nx>l</span> <span class=o>=</span> <span class=nx>w</span><span class=o>*</span><span class=nx>h</span><span class=p>;</span>
</span></span><span class=line><span class=ln>138</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>buf</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Float32Array</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>l</span><span class=p>);</span>
</span></span><span class=line><span class=ln>139</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>140</span><span class=cl>  <span class=nx>itox</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span> <span class=p>{</span><span class=k>return</span> <span class=nx>i</span> <span class=o>%</span> <span class=k>this</span><span class=p>.</span><span class=nx>w</span><span class=p>};</span>
</span></span><span class=line><span class=ln>141</span><span class=cl>  <span class=nx>itoy</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span> <span class=p>{</span><span class=k>return</span> <span class=nx>ftoi</span><span class=p>(</span><span class=nx>i</span> <span class=o>/</span> <span class=k>this</span><span class=p>.</span><span class=nx>w</span><span class=p>)};</span>
</span></span><span class=line><span class=ln>142</span><span class=cl>  <span class=nx>ctoi</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>)</span> <span class=p>{</span><span class=k>return</span> <span class=nx>x</span> <span class=o>+</span> <span class=p>(</span><span class=nx>y</span> <span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>w</span><span class=p>)};</span>
</span></span><span class=line><span class=ln>143</span><span class=cl>  <span class=nx>get</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>)</span> <span class=p>{</span><span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=k>this</span><span class=p>.</span><span class=nx>ctoi</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>)]};</span>
</span></span><span class=line><span class=ln>144</span><span class=cl>  <span class=nx>set</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>,</span> <span class=nx>v</span><span class=p>)</span> <span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=k>this</span><span class=p>.</span><span class=nx>ctoi</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>)]</span> <span class=o>=</span> <span class=nx>v</span><span class=p>;};</span>
</span></span><span class=line><span class=ln>145</span><span class=cl>  <span class=nx>add</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span> <span class=p>{</span><span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=k>this</span><span class=p>.</span><span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>){</span><span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>+</span> <span class=nx>v</span><span class=p>}};</span>
</span></span><span class=line><span class=ln>146</span><span class=cl>  <span class=nx>mul</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span> <span class=p>{</span><span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=k>this</span><span class=p>.</span><span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>){</span><span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>*</span> <span class=nx>v</span><span class=p>}};</span>
</span></span><span class=line><span class=ln>147</span><span class=cl>  <span class=nx>map</span><span class=p>(</span><span class=nx>cb</span><span class=p>)</span> <span class=p>{</span><span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=k>this</span><span class=p>.</span><span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>){</span><span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>cb</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=nx>i</span><span class=p>])}};</span>
</span></span><span class=line><span class=ln>148</span><span class=cl>  <span class=nx>zeros</span><span class=p>()</span> <span class=p>{</span><span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>}};</span>
</span></span><span class=line><span class=ln>149</span><span class=cl>  <span class=nx>getMin</span><span class=p>()</span> <span class=p>{</span><span class=k>return</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>min</span><span class=p>(...</span><span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>)};</span>
</span></span><span class=line><span class=ln>150</span><span class=cl>  <span class=nx>getMax</span><span class=p>()</span> <span class=p>{</span><span class=k>return</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>max</span><span class=p>(...</span><span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>)};</span>
</span></span><span class=line><span class=ln>151</span><span class=cl>  <span class=nx>load2DArray</span><span class=p>(</span><span class=nx>arr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>152</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>x</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>x</span><span class=o>&lt;</span><span class=k>this</span><span class=p>.</span><span class=nx>w</span><span class=p>;</span> <span class=nx>x</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>153</span><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>y</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>y</span><span class=o>&lt;</span><span class=k>this</span><span class=p>.</span><span class=nx>h</span><span class=p>;</span> <span class=nx>y</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>154</span><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>,</span> <span class=nx>arr</span><span class=p>[</span><span class=nx>y</span><span class=p>][</span><span class=nx>x</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>155</span><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=ln>156</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>157</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>158</span><span class=cl>  <span class=nx>loadImageData</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>159</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=nx>data</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>+=</span><span class=mi>4</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>160</span><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=nx>ftoi</span><span class=p>(</span><span class=nx>i</span><span class=o>/</span><span class=mi>4</span><span class=p>)]</span> <span class=o>=</span> <span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=nx>i</span><span class=o>+</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=nx>data</span><span class=p>[</span><span class=nx>i</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=nx>data</span><span class=p>[</span><span class=nx>i</span><span class=o>+</span><span class=mi>2</span><span class=p>])</span> <span class=o>/</span> <span class=mi>3</span> <span class=o>/</span> <span class=mi>255</span><span class=p>;</span>
</span></span><span class=line><span class=ln>161</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>162</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>163</span><span class=cl>  <span class=nx>unloadImageData</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>164</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=nx>data</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>+=</span><span class=mi>4</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>165</span><span class=cl>      <span class=kd>let</span> <span class=nx>p</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=nx>ftoi</span><span class=p>(</span><span class=nx>i</span><span class=o>/</span><span class=mi>4</span><span class=p>)];</span>
</span></span><span class=line><span class=ln>166</span><span class=cl>      <span class=nx>p</span> <span class=o>=</span> <span class=nx>p</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=o>?</span> <span class=mi>1</span> <span class=o>:</span> <span class=nx>p</span><span class=p>;</span>
</span></span><span class=line><span class=ln>167</span><span class=cl>      <span class=nx>p</span> <span class=o>=</span> <span class=nx>p</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>?</span> <span class=mi>0</span> <span class=o>:</span> <span class=nx>p</span><span class=p>;</span>
</span></span><span class=line><span class=ln>168</span><span class=cl>      <span class=nx>p</span> <span class=o>=</span> <span class=nx>ftoi</span><span class=p>(</span><span class=nx>p</span> <span class=o>*</span> <span class=mi>255</span><span class=p>);</span>
</span></span><span class=line><span class=ln>169</span><span class=cl>      <span class=nx>data</span><span class=p>[</span><span class=nx>i</span><span class=o>+</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=nx>p</span><span class=p>;</span>
</span></span><span class=line><span class=ln>170</span><span class=cl>      <span class=nx>data</span><span class=p>[</span><span class=nx>i</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=nx>p</span><span class=p>;</span>
</span></span><span class=line><span class=ln>171</span><span class=cl>      <span class=nx>data</span><span class=p>[</span><span class=nx>i</span><span class=o>+</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=nx>p</span><span class=p>;</span>
</span></span><span class=line><span class=ln>172</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>173</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>174</span><span class=cl>  <span class=nx>upscaleDilate</span><span class=p>(</span><span class=nx>m</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>175</span><span class=cl>    <span class=kd>let</span> <span class=nx>scale</span> <span class=o>=</span> <span class=nx>ftoi</span><span class=p>(</span><span class=nx>m</span><span class=p>.</span><span class=nx>w</span> <span class=o>/</span> <span class=k>this</span><span class=p>.</span><span class=nx>w</span><span class=p>);</span>
</span></span><span class=line><span class=ln>176</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>x</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>x</span><span class=o>&lt;</span><span class=k>this</span><span class=p>.</span><span class=nx>w</span><span class=p>;</span> <span class=nx>x</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>177</span><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>y</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>y</span><span class=o>&lt;</span><span class=k>this</span><span class=p>.</span><span class=nx>h</span><span class=p>;</span> <span class=nx>y</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>178</span><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=nx>scale</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>179</span><span class=cl>          <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>j</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>j</span><span class=o>&lt;</span><span class=nx>scale</span><span class=p>;</span> <span class=nx>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>180</span><span class=cl>            <span class=nx>m</span><span class=p>.</span><span class=nx>set</span><span class=p>((</span><span class=nx>x</span><span class=o>*</span><span class=nx>scale</span><span class=p>)</span><span class=o>+</span><span class=nx>i</span><span class=p>,</span> <span class=p>(</span><span class=nx>y</span><span class=o>*</span><span class=nx>scale</span><span class=p>)</span><span class=o>+</span><span class=nx>j</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>));</span>
</span></span><span class=line><span class=ln>181</span><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=ln>182</span><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=ln>183</span><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=ln>184</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>185</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>186</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>187</span><span class=cl>
</span></span><span class=line><span class=ln>188</span><span class=cl>
</span></span><span class=line><span class=ln>189</span><span class=cl><span class=cm>/*  Additional: activation functions
</span></span></span><span class=line><span class=ln>190</span><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=ln>191</span><span class=cl>
</span></span><span class=line><span class=ln>192</span><span class=cl><span class=kd>function</span> <span class=nx>Sigmoid</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span> <span class=p>{</span><span class=k>return</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=mi>1</span><span class=o>+</span><span class=nb>Math</span><span class=p>.</span><span class=nx>exp</span><span class=p>(</span><span class=o>-</span><span class=nx>v</span><span class=p>))};</span>
</span></span><span class=line><span class=ln>193</span><span class=cl><span class=kd>function</span> <span class=nx>ReLU</span><span class=p>(</span><span class=nx>v</span><span class=p>)</span> <span class=p>{</span><span class=k>return</span> <span class=nx>v</span><span class=o>&lt;</span><span class=mi>0</span><span class=o>?</span><span class=mi>0</span><span class=o>:</span><span class=nx>v</span><span class=p>};</span>
</span></span><span class=line><span class=ln>194</span><span class=cl>
</span></span><span class=line><span class=ln>195</span><span class=cl>
</span></span><span class=line><span class=ln>196</span><span class=cl><span class=cm>/*  Conv2D
</span></span></span><span class=line><span class=ln>197</span><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=ln>198</span><span class=cl>
</span></span><span class=line><span class=ln>199</span><span class=cl><span class=kd>function</span> <span class=nx>_conv2dsize</span><span class=p>(</span><span class=nx>inputSize</span><span class=p>,</span> <span class=nx>padding</span><span class=p>,</span> <span class=nx>kernelSize</span><span class=p>,</span> <span class=nx>stride</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>200</span><span class=cl>  <span class=k>return</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>floor</span><span class=p>((</span><span class=nx>inputSize</span> <span class=o>+</span> <span class=p>(</span><span class=nx>padding</span><span class=o>*</span><span class=mi>2</span><span class=p>)</span> <span class=o>-</span> <span class=p>(</span><span class=nx>kernelSize</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=nx>stride</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=ln>201</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>202</span><span class=cl>
</span></span><span class=line><span class=ln>203</span><span class=cl>
</span></span><span class=line><span class=ln>204</span><span class=cl><span class=kd>function</span> <span class=nx>conv2d_h</span><span class=p>(</span><span class=nx>src_w</span><span class=p>,</span> <span class=nx>src_h</span><span class=p>,</span> <span class=nx>dst_w</span><span class=p>,</span> <span class=nx>dst_h</span><span class=p>,</span> <span class=nx>kw</span><span class=p>,</span> <span class=nx>kh</span><span class=p>,</span> <span class=nx>px</span><span class=p>,</span> <span class=nx>py</span><span class=p>,</span> <span class=nx>sx</span><span class=p>,</span> <span class=nx>sy</span><span class=p>,</span> <span class=nx>cb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>205</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>dst_w</span> <span class=o>!==</span> <span class=nx>_conv2dsize</span><span class=p>(</span><span class=nx>src_w</span><span class=p>,</span> <span class=nx>px</span><span class=p>,</span> <span class=nx>kw</span><span class=p>,</span> <span class=nx>sx</span><span class=p>))</span> <span class=p>{</span> <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>dst_w</span><span class=p>,</span> <span class=nx>_conv2dsize</span><span class=p>(</span><span class=nx>src_w</span><span class=p>,</span> <span class=nx>px</span><span class=p>,</span> <span class=nx>kw</span><span class=p>,</span> <span class=nx>sx</span><span class=p>));</span> <span class=k>throw</span> <span class=s2>&#34;Invalid Output Matrix Size&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>206</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>dst_h</span> <span class=o>!==</span> <span class=nx>_conv2dsize</span><span class=p>(</span><span class=nx>src_h</span><span class=p>,</span> <span class=nx>py</span><span class=p>,</span> <span class=nx>kh</span><span class=p>,</span> <span class=nx>sy</span><span class=p>))</span> <span class=p>{</span> <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>dst_h</span><span class=p>,</span> <span class=nx>_conv2dsize</span><span class=p>(</span><span class=nx>src_h</span><span class=p>,</span> <span class=nx>py</span><span class=p>,</span> <span class=nx>kh</span><span class=p>,</span> <span class=nx>sy</span><span class=p>));</span> <span class=k>throw</span> <span class=s2>&#34;Invalid Output Matrix Size&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>207</span><span class=cl>  <span class=kd>let</span> <span class=nx>dx</span><span class=p>,</span> <span class=nx>dy</span><span class=p>,</span> <span class=nx>kx</span><span class=p>,</span> <span class=nx>ky</span><span class=p>;</span>
</span></span><span class=line><span class=ln>208</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=nx>dx</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>dx</span><span class=o>&lt;</span><span class=nx>dst_w</span><span class=p>;</span> <span class=nx>dx</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span><span class=k>for</span> <span class=p>(</span><span class=nx>dy</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>dy</span><span class=o>&lt;</span><span class=nx>dst_h</span><span class=p>;</span> <span class=nx>dy</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>209</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=nx>kx</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>kx</span><span class=o>&lt;</span><span class=nx>kw</span><span class=p>;</span> <span class=nx>kx</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span><span class=k>for</span> <span class=p>(</span><span class=nx>ky</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>ky</span><span class=o>&lt;</span><span class=nx>kh</span><span class=p>;</span> <span class=nx>ky</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>210</span><span class=cl>    <span class=nx>cb</span><span class=p>(</span><span class=nx>dx</span><span class=p>,</span> <span class=nx>dy</span><span class=p>,</span> <span class=nx>kx</span><span class=p>,</span> <span class=nx>ky</span><span class=p>,</span> <span class=p>(</span><span class=nx>dx</span><span class=o>*</span><span class=nx>sx</span><span class=p>)</span><span class=o>+</span><span class=nx>kx</span><span class=o>-</span><span class=p>(</span><span class=nx>px</span><span class=o>||</span><span class=mi>0</span><span class=p>),</span> <span class=p>(</span><span class=nx>dy</span><span class=o>*</span><span class=nx>sy</span><span class=p>)</span><span class=o>+</span><span class=nx>ky</span><span class=o>-</span><span class=p>(</span><span class=nx>py</span><span class=o>||</span><span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=ln>211</span><span class=cl>  <span class=p>}}}};</span>
</span></span><span class=line><span class=ln>212</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>213</span><span class=cl>
</span></span><span class=line><span class=ln>214</span><span class=cl>
</span></span><span class=line><span class=ln>215</span><span class=cl><span class=kr>class</span> <span class=nx>CNNConv2D</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>216</span><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>kernel</span><span class=p>,</span> <span class=nx>stride</span><span class=p>,</span> <span class=nx>padding</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>217</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>kernel</span> <span class=o>=</span> <span class=nx>kernel</span><span class=p>;</span>
</span></span><span class=line><span class=ln>218</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>stride</span> <span class=o>=</span> <span class=nx>stride</span> <span class=o>||</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=ln>219</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>padding</span> <span class=o>=</span> <span class=nx>padding</span> <span class=o>||</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>220</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>221</span><span class=cl>
</span></span><span class=line><span class=ln>222</span><span class=cl>  <span class=nx>forward</span><span class=p>(</span><span class=nx>ms</span><span class=p>,</span> <span class=nx>md</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>223</span><span class=cl>    <span class=nx>conv2d_h</span><span class=p>(</span><span class=nx>ms</span><span class=p>.</span><span class=nx>w</span><span class=p>,</span> <span class=nx>ms</span><span class=p>.</span><span class=nx>h</span><span class=p>,</span> <span class=nx>md</span><span class=p>.</span><span class=nx>w</span><span class=p>,</span> <span class=nx>md</span><span class=p>.</span><span class=nx>h</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>kernel</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>length</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>kernel</span><span class=p>.</span><span class=nx>length</span><span class=p>,</span>
</span></span><span class=line><span class=ln>224</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>padding</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>padding</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>stride</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>stride</span><span class=p>,</span>
</span></span><span class=line><span class=ln>225</span><span class=cl>    <span class=p>(</span><span class=nx>dx</span><span class=p>,</span> <span class=nx>dy</span><span class=p>,</span> <span class=nx>kx</span><span class=p>,</span> <span class=nx>ky</span><span class=p>,</span> <span class=nx>sx</span><span class=p>,</span> <span class=nx>sy</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=ln>226</span><span class=cl>      <span class=nx>md</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>dx</span><span class=p>,</span> <span class=nx>dy</span><span class=p>,</span> <span class=nx>md</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>dx</span><span class=p>,</span> <span class=nx>dy</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=nx>ms</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>sx</span><span class=p>,</span> <span class=nx>sy</span><span class=p>)</span> <span class=o>||</span> <span class=mi>0</span><span class=p>)</span> <span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>kernel</span><span class=p>[</span><span class=nx>ky</span><span class=p>][</span><span class=nx>kx</span><span class=p>])</span>
</span></span><span class=line><span class=ln>227</span><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=ln>228</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>229</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>230</span><span class=cl>
</span></span><span class=line><span class=ln>231</span><span class=cl>
</span></span><span class=line><span class=ln>232</span><span class=cl><span class=cm>/*  MaxPool2D
</span></span></span><span class=line><span class=ln>233</span><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=ln>234</span><span class=cl>
</span></span><span class=line><span class=ln>235</span><span class=cl><span class=kr>class</span> <span class=nx>CNNMaxPool2D</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>236</span><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>h</span><span class=p>,</span> <span class=nx>stride</span><span class=p>,</span> <span class=nx>padding</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>237</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>w</span> <span class=o>=</span> <span class=nx>w</span><span class=p>;</span>
</span></span><span class=line><span class=ln>238</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>h</span> <span class=o>=</span> <span class=nx>h</span><span class=p>;</span>
</span></span><span class=line><span class=ln>239</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>stride</span> <span class=o>=</span> <span class=nx>stride</span> <span class=o>||</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=ln>240</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>padding</span> <span class=o>=</span> <span class=nx>padding</span> <span class=o>||</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>241</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>242</span><span class=cl>
</span></span><span class=line><span class=ln>243</span><span class=cl>  <span class=nx>forward</span><span class=p>(</span><span class=nx>ms</span><span class=p>,</span> <span class=nx>md</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>244</span><span class=cl>    <span class=nx>md</span><span class=p>.</span><span class=nx>zeros</span><span class=p>();</span>
</span></span><span class=line><span class=ln>245</span><span class=cl>    <span class=nx>md</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=o>-</span><span class=mf>1e31</span><span class=p>);</span>
</span></span><span class=line><span class=ln>246</span><span class=cl>    <span class=nx>conv2d_h</span><span class=p>(</span><span class=nx>ms</span><span class=p>.</span><span class=nx>w</span><span class=p>,</span> <span class=nx>ms</span><span class=p>.</span><span class=nx>h</span><span class=p>,</span> <span class=nx>md</span><span class=p>.</span><span class=nx>w</span><span class=p>,</span> <span class=nx>md</span><span class=p>.</span><span class=nx>h</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>w</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>h</span><span class=p>,</span>
</span></span><span class=line><span class=ln>247</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>padding</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>padding</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>stride</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>stride</span><span class=p>,</span>
</span></span><span class=line><span class=ln>248</span><span class=cl>    <span class=p>(</span><span class=nx>dx</span><span class=p>,</span> <span class=nx>dy</span><span class=p>,</span> <span class=nx>kx</span><span class=p>,</span> <span class=nx>ky</span><span class=p>,</span> <span class=nx>sx</span><span class=p>,</span> <span class=nx>sy</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=ln>249</span><span class=cl>      <span class=nx>md</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=nx>dx</span><span class=p>,</span> <span class=nx>dy</span><span class=p>,</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>max</span><span class=p>(</span><span class=nx>md</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>dx</span><span class=p>,</span> <span class=nx>dy</span><span class=p>),</span> <span class=p>(</span><span class=nx>ms</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>sx</span><span class=p>,</span> <span class=nx>sy</span><span class=p>)</span> <span class=o>||</span> <span class=mi>0</span><span class=p>)))</span>
</span></span><span class=line><span class=ln>250</span><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=ln>251</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>252</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>253</span><span class=cl>
</span></span><span class=line><span class=ln>254</span><span class=cl>
</span></span><span class=line><span class=ln>255</span><span class=cl><span class=cm>/*  Linear
</span></span></span><span class=line><span class=ln>256</span><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=ln>257</span><span class=cl>
</span></span><span class=line><span class=ln>258</span><span class=cl><span class=kr>class</span> <span class=nx>Linear</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>259</span><span class=cl>  <span class=nx>constructor</span> <span class=p>(</span><span class=nx>A</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>260</span><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>A</span> <span class=o>=</span> <span class=nx>A</span><span class=p>;</span>
</span></span><span class=line><span class=ln>261</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>262</span><span class=cl>
</span></span><span class=line><span class=ln>263</span><span class=cl>  <span class=nx>forward</span><span class=p>(</span><span class=nx>ms</span><span class=p>,</span> <span class=nx>md</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>264</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>x</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>x</span><span class=o>&lt;</span><span class=k>this</span><span class=p>.</span><span class=nx>A</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>length</span><span class=p>;</span> <span class=nx>x</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>265</span><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>y</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>y</span><span class=o>&lt;</span><span class=k>this</span><span class=p>.</span><span class=nx>A</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>y</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>266</span><span class=cl>        <span class=nx>md</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=nx>y</span><span class=p>]</span> <span class=o>+=</span> <span class=nx>ms</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=nx>x</span><span class=p>]</span> <span class=o>*</span> <span class=k>this</span><span class=p>.</span><span class=nx>A</span><span class=p>[</span><span class=nx>y</span><span class=p>][</span><span class=nx>x</span><span class=p>];</span>
</span></span><span class=line><span class=ln>267</span><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=ln>268</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>269</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>270</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>271</span><span class=cl>
</span></span><span class=line><span class=ln>272</span><span class=cl>
</span></span><span class=line><span class=ln>273</span><span class=cl><span class=cm>/*  ==================== Canvas routines ==================== */</span>
</span></span><span class=line><span class=ln>274</span><span class=cl>
</span></span><span class=line><span class=ln>275</span><span class=cl><span class=kd>function</span> <span class=nx>canvasSubRoutineDrawDot</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>276</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>fillStyle</span> <span class=o>=</span> <span class=s2>&#34;white&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>277</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>filter</span> <span class=o>=</span> <span class=s2>&#34;blur(5px)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>278</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>beginPath</span><span class=p>();</span>
</span></span><span class=line><span class=ln>279</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>arc</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>,</span> <span class=mi>14</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>2</span> <span class=o>*</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>PI</span><span class=p>);</span>
</span></span><span class=line><span class=ln>280</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>fill</span><span class=p>();</span>
</span></span><span class=line><span class=ln>281</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>282</span><span class=cl>
</span></span><span class=line><span class=ln>283</span><span class=cl>
</span></span><span class=line><span class=ln>284</span><span class=cl><span class=kd>function</span> <span class=nx>canvasSubRoutineDrawLine</span><span class=p>(</span><span class=nx>x1</span><span class=p>,</span> <span class=nx>y1</span><span class=p>,</span> <span class=nx>x2</span><span class=p>,</span> <span class=nx>y2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>285</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>strokeStyle</span> <span class=o>=</span> <span class=s2>&#34;white&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>286</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>filter</span> <span class=o>=</span> <span class=s2>&#34;blur(5px)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>287</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>lineWidth</span> <span class=o>=</span> <span class=mi>28</span><span class=p>;</span>
</span></span><span class=line><span class=ln>288</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>lineCap</span> <span class=o>=</span> <span class=s2>&#34;round&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>289</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>beginPath</span><span class=p>();</span>
</span></span><span class=line><span class=ln>290</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>moveTo</span><span class=p>(</span><span class=nx>x1</span><span class=p>,</span> <span class=nx>y1</span><span class=p>);</span>
</span></span><span class=line><span class=ln>291</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>lineTo</span><span class=p>(</span><span class=nx>x2</span><span class=p>,</span> <span class=nx>y2</span><span class=p>);</span>
</span></span><span class=line><span class=ln>292</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>stroke</span><span class=p>();</span>
</span></span><span class=line><span class=ln>293</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>294</span><span class=cl>
</span></span><span class=line><span class=ln>295</span><span class=cl>
</span></span><span class=line><span class=ln>296</span><span class=cl><span class=kd>function</span> <span class=nx>canvasSubRoutineDrawText</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>,</span> <span class=nx>text</span><span class=p>,</span> <span class=nx>align</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>297</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>save</span><span class=p>();</span>
</span></span><span class=line><span class=ln>298</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>fillStyle</span> <span class=o>=</span> <span class=s2>&#34;black&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>299</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>font</span> <span class=o>=</span> <span class=s2>&#34;32px monospace&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>300</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>textBaseline</span> <span class=o>=</span> <span class=s2>&#34;middle&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>301</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>textAlign</span> <span class=o>=</span> <span class=nx>align</span> <span class=o>||</span> <span class=s2>&#34;left&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>302</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>fillText</span><span class=p>(</span><span class=nx>text</span><span class=p>,</span> <span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln>303</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>304</span><span class=cl>
</span></span><span class=line><span class=ln>305</span><span class=cl>
</span></span><span class=line><span class=ln>306</span><span class=cl><span class=kd>function</span> <span class=nx>canvasSubRoutineDrawMatrix</span><span class=p>(</span><span class=nx>mat_src</span><span class=p>,</span> <span class=nx>mat_tmp</span><span class=p>,</span> <span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>,</span> <span class=nx>normalize</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>307</span><span class=cl>  <span class=kr>const</span> <span class=nx>imd</span> <span class=o>=</span> <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>getImageData</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>,</span> <span class=nx>mat_tmp</span><span class=p>.</span><span class=nx>w</span><span class=p>,</span> <span class=nx>mat_tmp</span><span class=p>.</span><span class=nx>h</span><span class=p>);</span>
</span></span><span class=line><span class=ln>308</span><span class=cl>  <span class=nx>Interp</span><span class=p>.</span><span class=nx>binearest_m</span><span class=p>(</span><span class=nx>mat_src</span><span class=p>,</span> <span class=nx>mat_tmp</span><span class=p>)</span>
</span></span><span class=line><span class=ln>309</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>normalize</span> <span class=o>||</span> <span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>310</span><span class=cl>    <span class=kd>let</span> <span class=nx>mi</span> <span class=o>=</span> <span class=nx>mat_tmp</span><span class=p>.</span><span class=nx>getMin</span><span class=p>();</span>
</span></span><span class=line><span class=ln>311</span><span class=cl>    <span class=kd>let</span> <span class=nx>ma</span> <span class=o>=</span> <span class=nx>mat_tmp</span><span class=p>.</span><span class=nx>getMax</span><span class=p>();</span>
</span></span><span class=line><span class=ln>312</span><span class=cl>    <span class=nx>mat_tmp</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=o>-</span><span class=nx>mi</span><span class=p>);</span>
</span></span><span class=line><span class=ln>313</span><span class=cl>    <span class=nx>mat_tmp</span><span class=p>.</span><span class=nx>mul</span><span class=p>(</span><span class=mi>1</span><span class=o>/</span><span class=p>(</span><span class=nx>ma</span><span class=o>-</span><span class=nx>mi</span><span class=p>));</span>
</span></span><span class=line><span class=ln>314</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>315</span><span class=cl>  <span class=nx>mat_tmp</span><span class=p>.</span><span class=nx>unloadImageData</span><span class=p>(</span><span class=nx>imd</span><span class=p>.</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=ln>316</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>putImageData</span><span class=p>(</span><span class=nx>imd</span><span class=p>,</span> <span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln>317</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>strokeStyle</span> <span class=o>=</span> <span class=s2>&#34;blue&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>318</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>rect</span><span class=p>(</span><span class=nx>x</span><span class=o>-</span><span class=mi>2</span><span class=p>,</span><span class=nx>y</span><span class=o>-</span><span class=mi>2</span><span class=p>,</span><span class=nx>mat_tmp</span><span class=p>.</span><span class=nx>w</span><span class=o>+</span><span class=mi>4</span><span class=p>,</span> <span class=nx>mat_tmp</span><span class=p>.</span><span class=nx>h</span><span class=o>+</span><span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=ln>319</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>stroke</span><span class=p>();</span>
</span></span><span class=line><span class=ln>320</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>321</span><span class=cl>
</span></span><span class=line><span class=ln>322</span><span class=cl>
</span></span><span class=line><span class=ln>323</span><span class=cl><span class=kd>function</span> <span class=nx>canvasSubRoutineDrawDense</span><span class=p>(</span><span class=nx>mat_src</span><span class=p>,</span> <span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>,</span> <span class=nx>w</span><span class=p>,</span> <span class=nx>h</span><span class=p>,</span> <span class=nx>draw_text</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>324</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>save</span><span class=p>()</span>
</span></span><span class=line><span class=ln>325</span><span class=cl>  <span class=kd>let</span> <span class=nx>r</span> <span class=o>=</span> <span class=nx>w</span> <span class=o>/</span> <span class=nx>mat_src</span><span class=p>.</span><span class=nx>w</span><span class=p>;</span>
</span></span><span class=line><span class=ln>326</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>fillStyle</span> <span class=o>=</span> <span class=s2>&#34;white&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>327</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>strokeStyle</span> <span class=o>=</span> <span class=s2>&#34;black&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>328</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>beginPath</span><span class=p>();</span>
</span></span><span class=line><span class=ln>329</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>rect</span><span class=p>(</span><span class=nx>x</span><span class=p>,</span> <span class=nx>y</span><span class=p>,</span> <span class=nx>w</span><span class=p>,</span> <span class=nx>h</span><span class=p>)</span>
</span></span><span class=line><span class=ln>330</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>fill</span><span class=p>()</span>
</span></span><span class=line><span class=ln>331</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=nx>mat_src</span><span class=p>.</span><span class=nx>w</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>332</span><span class=cl>    <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>rect</span><span class=p>(</span><span class=nx>x</span><span class=o>+</span><span class=nx>r</span><span class=o>*</span><span class=nx>i</span><span class=p>,</span><span class=nx>y</span><span class=p>,</span><span class=nx>r</span><span class=p>,</span><span class=nx>h</span><span class=p>);</span>
</span></span><span class=line><span class=ln>333</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>334</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>stroke</span><span class=p>()</span>
</span></span><span class=line><span class=ln>335</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=nx>mat_src</span><span class=p>.</span><span class=nx>w</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>336</span><span class=cl>    <span class=kd>let</span> <span class=nx>hh</span> <span class=o>=</span> <span class=nx>h</span><span class=o>*</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=nx>mat_src</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=ln>337</span><span class=cl>    <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>fillStyle</span> <span class=o>=</span> <span class=s2>&#34;blue&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>338</span><span class=cl>    <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>fillRect</span><span class=p>(</span><span class=nx>x</span><span class=o>+</span><span class=nx>r</span><span class=o>*</span><span class=nx>i</span><span class=p>,</span><span class=nx>y</span><span class=o>+</span><span class=nx>hh</span><span class=p>,</span><span class=nx>r</span><span class=p>,</span><span class=nx>h</span><span class=o>-</span><span class=nx>hh</span><span class=p>);</span>
</span></span><span class=line><span class=ln>339</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>draw_text</span> <span class=o>||</span> <span class=kc>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>340</span><span class=cl>      <span class=nx>canvasSubRoutineDrawText</span><span class=p>(</span><span class=nx>x</span><span class=o>+</span><span class=nx>r</span><span class=o>*</span><span class=nx>i</span><span class=o>+</span><span class=nx>r</span><span class=o>/</span><span class=mi>2</span><span class=p>,</span> <span class=nx>y</span><span class=o>+</span><span class=nx>h</span><span class=o>+</span><span class=mi>32</span><span class=p>,</span> <span class=s2>&#34;&#34;</span> <span class=o>+</span> <span class=nx>i</span><span class=p>,</span> <span class=s1>&#39;center&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>341</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>342</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>343</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>restore</span><span class=p>()</span>
</span></span><span class=line><span class=ln>344</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>345</span><span class=cl>
</span></span><span class=line><span class=ln>346</span><span class=cl>
</span></span><span class=line><span class=ln>347</span><span class=cl><span class=kd>function</span> <span class=nx>netDrawAnnotation</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>348</span><span class=cl>  <span class=nx>canvasSubRoutineDrawText</span><span class=p>(</span><span class=mi>150</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span>         <span class=s2>&#34;input(512x512)&#34;</span><span class=p>,</span> <span class=s2>&#34;center&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>349</span><span class=cl>  <span class=nx>canvasSubRoutineDrawText</span><span class=p>(</span><span class=mi>150</span><span class=p>,</span> <span class=mi>60</span><span class=p>,</span>         <span class=s2>&#34;downsamp(28x28)&#34;</span><span class=p>,</span> <span class=s2>&#34;center&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>350</span><span class=cl>  <span class=nx>canvasSubRoutineDrawText</span><span class=p>(</span><span class=mi>300</span><span class=p>,</span> <span class=mi>80</span><span class=o>-</span><span class=mi>20</span><span class=p>,</span>      <span class=s2>&#34;C1: Conv2D 5x5pad2 (28x28) x6 (Sigmoid)&#34;</span><span class=p>,</span> <span class=s2>&#34;left&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>351</span><span class=cl>  <span class=nx>canvasSubRoutineDrawText</span><span class=p>(</span><span class=mi>300</span><span class=p>,</span> <span class=mi>260</span><span class=o>-</span><span class=mi>20</span><span class=p>,</span>     <span class=s2>&#34;S2: MaxPool 2x2stride2 (14x14) x6&#34;</span><span class=p>,</span> <span class=s2>&#34;left&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>352</span><span class=cl>  <span class=nx>canvasSubRoutineDrawText</span><span class=p>(</span><span class=mi>30</span><span class=p>,</span>  <span class=mi>470</span><span class=o>-</span><span class=mi>20</span><span class=p>,</span>     <span class=s2>&#34;C3: Conv2D 5x5 (10x10) x16 (Sigmoid)&#34;</span><span class=p>,</span> <span class=s2>&#34;left&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>353</span><span class=cl>  <span class=nx>canvasSubRoutineDrawText</span><span class=p>(</span><span class=mi>30</span><span class=p>,</span>  <span class=mi>800</span><span class=o>-</span><span class=mi>20</span><span class=p>,</span>     <span class=s2>&#34;S4: MaxPool 2x2stride2 (5x5) x16&#34;</span><span class=p>,</span> <span class=s2>&#34;left&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>354</span><span class=cl>  <span class=nx>canvasSubRoutineDrawText</span><span class=p>(</span><span class=mi>30</span><span class=p>,</span>  <span class=mi>1076</span><span class=o>+</span><span class=mi>260</span><span class=o>*</span><span class=mi>0</span><span class=p>,</span> <span class=s2>&#34;C5: Conv2D 5x5 (1x1) x120 Flatten (Sigmoid)&#34;</span><span class=p>,</span> <span class=s2>&#34;left&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>355</span><span class=cl>  <span class=nx>canvasSubRoutineDrawText</span><span class=p>(</span><span class=mi>30</span><span class=p>,</span>  <span class=mi>1076</span><span class=o>+</span><span class=mi>260</span><span class=o>*</span><span class=mi>1</span><span class=p>,</span> <span class=s2>&#34;F6: Linear (84x120) (Sigmoid)&#34;</span><span class=p>,</span> <span class=s2>&#34;left&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>356</span><span class=cl>  <span class=nx>canvasSubRoutineDrawText</span><span class=p>(</span><span class=mi>30</span><span class=p>,</span>  <span class=mi>1076</span><span class=o>+</span><span class=mi>260</span><span class=o>*</span><span class=mi>2</span><span class=p>,</span> <span class=s2>&#34;F0: Linear (10x84) (Sigmoid)&#34;</span><span class=p>,</span> <span class=s2>&#34;left&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>357</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>358</span><span class=cl>
</span></span><span class=line><span class=ln>359</span><span class=cl>
</span></span><span class=line><span class=ln>360</span><span class=cl><span class=kd>function</span> <span class=nx>appInCanvasReset</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>361</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>fillStyle</span> <span class=o>=</span> <span class=s2>&#34;black&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>362</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>clearRect</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nx>cvIn</span><span class=p>.</span><span class=nx>width</span><span class=p>,</span><span class=nx>cvIn</span><span class=p>.</span><span class=nx>height</span><span class=p>);</span>
</span></span><span class=line><span class=ln>363</span><span class=cl>  <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>fillRect</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nx>cvIn</span><span class=p>.</span><span class=nx>width</span><span class=p>,</span><span class=nx>cvIn</span><span class=p>.</span><span class=nx>height</span><span class=p>);</span>
</span></span><span class=line><span class=ln>364</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>save</span><span class=p>();</span>
</span></span><span class=line><span class=ln>365</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>fillStyle</span> <span class=o>=</span> <span class=s2>&#34;white&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>366</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>clearRect</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nx>cvPt</span><span class=p>.</span><span class=nx>width</span><span class=p>,</span><span class=nx>cvPt</span><span class=p>.</span><span class=nx>height</span><span class=p>);</span>
</span></span><span class=line><span class=ln>367</span><span class=cl>  <span class=nx>cvPtCtx</span><span class=p>.</span><span class=nx>fillRect</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nx>cvPt</span><span class=p>.</span><span class=nx>width</span><span class=p>,</span><span class=nx>cvPt</span><span class=p>.</span><span class=nx>height</span><span class=p>);</span>
</span></span><span class=line><span class=ln>368</span><span class=cl>  <span class=nx>netDrawAnnotation</span><span class=p>();</span>
</span></span><span class=line><span class=ln>369</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>370</span><span class=cl>
</span></span><span class=line><span class=ln>371</span><span class=cl>
</span></span><span class=line><span class=ln>372</span><span class=cl><span class=cm>/*  temporary buffers
</span></span></span><span class=line><span class=ln>373</span><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=ln>374</span><span class=cl>
</span></span><span class=line><span class=ln>375</span><span class=cl><span class=kr>const</span> <span class=nx>tmp_buf</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>376</span><span class=cl><span class=c1>// tmp_buf.m2032 = new cFloat32Matrix(32, 32);
</span></span></span><span class=line><span class=ln>377</span><span class=cl><span class=c1>// tmp_buf.m2048 = new cFloat32Matrix(48, 48);
</span></span></span><span class=line><span class=ln>378</span><span class=cl><span class=c1>// tmp_buf.m2064 = new cFloat32Matrix(64, 64);
</span></span></span><span class=line><span class=ln>379</span><span class=cl><span class=c1></span><span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2080</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=mi>80</span><span class=p>,</span> <span class=mi>80</span><span class=p>);</span>
</span></span><span class=line><span class=ln>380</span><span class=cl><span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2100</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=ln>381</span><span class=cl><span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2112</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=mi>112</span><span class=p>,</span> <span class=mi>112</span><span class=p>);</span>
</span></span><span class=line><span class=ln>382</span><span class=cl><span class=c1>// tmp_buf.m2140 = new cFloat32Matrix(140, 140);
</span></span></span><span class=line><span class=ln>383</span><span class=cl><span class=c1></span><span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2120</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=mi>120</span><span class=p>,</span> <span class=mi>120</span><span class=p>);</span>
</span></span><span class=line><span class=ln>384</span><span class=cl><span class=c1>// tmp_buf.m2160 = new cFloat32Matrix(160, 160);
</span></span></span><span class=line><span class=ln>385</span><span class=cl><span class=c1></span><span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2240</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=mi>240</span><span class=p>,</span> <span class=mi>240</span><span class=p>);</span>
</span></span><span class=line><span class=ln>386</span><span class=cl><span class=c1>// tmp_buf.m2028 = new cFloat32Matrix(28, 28);
</span></span></span><span class=line><span class=ln>387</span><span class=cl><span class=c1>// tmp_buf.m2014 = new cFloat32Matrix(14, 14);
</span></span></span><span class=line><span class=ln>388</span><span class=cl><span class=c1>// tmp_buf.m2005 = new cFloat32Matrix(5, 5);
</span></span></span><span class=line><span class=ln>389</span><span class=cl><span class=c1>// tmp_buf.m2002 = new cFloat32Matrix(2, 2);
</span></span></span><span class=line><span class=ln>390</span><span class=cl><span class=c1></span><span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2001</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=ln>391</span><span class=cl><span class=c1>// tmp_buf.m1120 = new cFloat32Matrix(120, 1);
</span></span></span><span class=line><span class=ln>392</span><span class=cl><span class=c1>// tmp_buf.m1084 = new cFloat32Matrix(84, 1);
</span></span></span><span class=line><span class=ln>393</span><span class=cl><span class=c1>// tmp_buf.m1010 = new cFloat32Matrix(10, 1);
</span></span></span><span class=line><span class=ln>394</span><span class=cl><span class=c1></span>
</span></span><span class=line><span class=ln>395</span><span class=cl><span class=cm>/*  layers and main buffers
</span></span></span><span class=line><span class=ln>396</span><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=ln>397</span><span class=cl>
</span></span><span class=line><span class=ln>398</span><span class=cl><span class=nx>layers</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>399</span><span class=cl><span class=nx>buffers</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>400</span><span class=cl><span class=nx>buffers</span><span class=p>.</span><span class=nx>input</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=nx>cvIn</span><span class=p>.</span><span class=nx>width</span><span class=p>,</span> <span class=nx>cvIn</span><span class=p>.</span><span class=nx>height</span><span class=p>);</span>
</span></span><span class=line><span class=ln>401</span><span class=cl><span class=nx>buffers</span><span class=p>.</span><span class=nx>ds28</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=mi>28</span><span class=p>,</span> <span class=mi>28</span><span class=p>);</span>
</span></span><span class=line><span class=ln>402</span><span class=cl>
</span></span><span class=line><span class=ln>403</span><span class=cl><span class=kd>function</span> <span class=nx>netInit</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>404</span><span class=cl>  <span class=kr>const</span> <span class=nx>pool2d2x2</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>CNNMaxPool2D</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>405</span><span class=cl>  <span class=nx>buffers</span><span class=p>.</span><span class=nx>c1</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>406</span><span class=cl>  <span class=nx>buffers</span><span class=p>.</span><span class=nx>s2</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>407</span><span class=cl>  <span class=nx>buffers</span><span class=p>.</span><span class=nx>c3</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>408</span><span class=cl>  <span class=nx>buffers</span><span class=p>.</span><span class=nx>s4</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>409</span><span class=cl>  <span class=nx>buffers</span><span class=p>.</span><span class=nx>c5</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>410</span><span class=cl>  <span class=nx>buffers</span><span class=p>.</span><span class=nx>f6</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>411</span><span class=cl>  <span class=nx>buffers</span><span class=p>.</span><span class=nx>fo</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>412</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>   <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=mi>28</span><span class=p>,</span> <span class=mi>28</span><span class=p>)};</span>
</span></span><span class=line><span class=ln>413</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>   <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>s2</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=mi>14</span><span class=p>,</span> <span class=mi>14</span><span class=p>)};</span>
</span></span><span class=line><span class=ln>414</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>16</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>  <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>c3</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>10</span><span class=p>)};</span>
</span></span><span class=line><span class=ln>415</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>16</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>  <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>s4</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mi>5</span><span class=p>)};</span>
</span></span><span class=line><span class=ln>416</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>1</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>   <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>c5</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=mi>120</span><span class=p>,</span> <span class=mi>1</span><span class=p>)};</span>
</span></span><span class=line><span class=ln>417</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>1</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>   <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>f6</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=mi>84</span><span class=p>,</span> <span class=mi>1</span><span class=p>)};</span>
</span></span><span class=line><span class=ln>418</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>1</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>   <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>fo</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cFloat32Matrix</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>1</span><span class=p>)};</span>
</span></span><span class=line><span class=ln>419</span><span class=cl>  <span class=nx>layers</span><span class=p>.</span><span class=nx>c1</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>420</span><span class=cl>  <span class=nx>layers</span><span class=p>.</span><span class=nx>s2</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>421</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>   <span class=p>{</span>
</span></span><span class=line><span class=ln>422</span><span class=cl>    <span class=nx>layers</span><span class=p>.</span><span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>423</span><span class=cl>    <span class=nx>layers</span><span class=p>.</span><span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>conv2d</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>CNNConv2D</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=s1>&#39;c1_conv.weight&#39;</span><span class=p>][</span><span class=nx>i</span><span class=p>][</span><span class=mi>0</span><span class=p>],</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=ln>424</span><span class=cl>    <span class=nx>layers</span><span class=p>.</span><span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>bias</span> <span class=o>=</span> <span class=nx>data</span><span class=p>[</span><span class=s1>&#39;c1_conv.bias&#39;</span><span class=p>][</span><span class=nx>i</span><span class=p>];</span>
</span></span><span class=line><span class=ln>425</span><span class=cl>    <span class=nx>layers</span><span class=p>.</span><span class=nx>s2</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>426</span><span class=cl>    <span class=nx>layers</span><span class=p>.</span><span class=nx>s2</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>pool2d</span> <span class=o>=</span> <span class=nx>pool2d2x2</span><span class=p>;</span>
</span></span><span class=line><span class=ln>427</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>428</span><span class=cl>  <span class=nx>layers</span><span class=p>.</span><span class=nx>c3</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>429</span><span class=cl>  <span class=nx>layers</span><span class=p>.</span><span class=nx>s4</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>430</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>j</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>j</span><span class=o>&lt;</span><span class=mi>16</span><span class=p>;</span> <span class=nx>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>431</span><span class=cl>    <span class=nx>layers</span><span class=p>.</span><span class=nx>c3</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>432</span><span class=cl>    <span class=nx>layers</span><span class=p>.</span><span class=nx>c3</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nx>bias</span> <span class=o>=</span> <span class=nx>data</span><span class=p>[</span><span class=s1>&#39;c3_conv.bias&#39;</span><span class=p>][</span><span class=nx>j</span><span class=p>];</span>
</span></span><span class=line><span class=ln>433</span><span class=cl>    <span class=nx>layers</span><span class=p>.</span><span class=nx>s4</span><span class=p>[</span><span class=nx>j</span><span class=p>]</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>434</span><span class=cl>    <span class=nx>layers</span><span class=p>.</span><span class=nx>s4</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nx>pool2d</span> <span class=o>=</span> <span class=nx>pool2d2x2</span><span class=p>;</span>
</span></span><span class=line><span class=ln>435</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>436</span><span class=cl>      <span class=nx>layers</span><span class=p>.</span><span class=nx>c3</span><span class=p>[</span><span class=nx>j</span><span class=p>][</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>437</span><span class=cl>      <span class=nx>layers</span><span class=p>.</span><span class=nx>c3</span><span class=p>[</span><span class=nx>j</span><span class=p>][</span><span class=nx>i</span><span class=p>].</span><span class=nx>conv2d</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>CNNConv2D</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=s1>&#39;c3_conv.weight&#39;</span><span class=p>][</span><span class=nx>j</span><span class=p>][</span><span class=nx>i</span><span class=p>],</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=ln>438</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>439</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>440</span><span class=cl>  <span class=nx>layers</span><span class=p>.</span><span class=nx>c5</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>441</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>k</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>k</span><span class=o>&lt;</span><span class=mi>120</span><span class=p>;</span> <span class=nx>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>442</span><span class=cl>    <span class=nx>layers</span><span class=p>.</span><span class=nx>c5</span><span class=p>[</span><span class=nx>k</span><span class=p>]</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>443</span><span class=cl>    <span class=nx>layers</span><span class=p>.</span><span class=nx>c5</span><span class=p>[</span><span class=nx>k</span><span class=p>].</span><span class=nx>bias</span> <span class=o>=</span> <span class=nx>data</span><span class=p>[</span><span class=s1>&#39;c5_conv.bias&#39;</span><span class=p>][</span><span class=nx>k</span><span class=p>];</span>
</span></span><span class=line><span class=ln>444</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>j</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>j</span><span class=o>&lt;</span><span class=mi>16</span><span class=p>;</span> <span class=nx>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>445</span><span class=cl>      <span class=nx>layers</span><span class=p>.</span><span class=nx>c5</span><span class=p>[</span><span class=nx>k</span><span class=p>][</span><span class=nx>j</span><span class=p>]</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>446</span><span class=cl>      <span class=nx>layers</span><span class=p>.</span><span class=nx>c5</span><span class=p>[</span><span class=nx>k</span><span class=p>][</span><span class=nx>j</span><span class=p>].</span><span class=nx>conv2d</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>CNNConv2D</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=s1>&#39;c5_conv.weight&#39;</span><span class=p>][</span><span class=nx>k</span><span class=p>][</span><span class=nx>j</span><span class=p>],</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=ln>447</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>448</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>449</span><span class=cl>  <span class=nx>layers</span><span class=p>.</span><span class=nx>f6</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>450</span><span class=cl>  <span class=nx>layers</span><span class=p>.</span><span class=nx>f6</span><span class=p>.</span><span class=nx>linear</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Linear</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=s1>&#39;f6_linr.weight&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>451</span><span class=cl>  <span class=nx>layers</span><span class=p>.</span><span class=nx>f6</span><span class=p>.</span><span class=nx>bias</span> <span class=o>=</span> <span class=nx>data</span><span class=p>[</span><span class=s1>&#39;f6_linr.bias&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=ln>452</span><span class=cl>  <span class=nx>layers</span><span class=p>.</span><span class=nx>fo</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln>453</span><span class=cl>  <span class=nx>layers</span><span class=p>.</span><span class=nx>fo</span><span class=p>.</span><span class=nx>linear</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Linear</span><span class=p>(</span><span class=nx>data</span><span class=p>[</span><span class=s1>&#39;fo_linr.weight&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=ln>454</span><span class=cl>  <span class=nx>layers</span><span class=p>.</span><span class=nx>fo</span><span class=p>.</span><span class=nx>bias</span> <span class=o>=</span> <span class=nx>data</span><span class=p>[</span><span class=s1>&#39;fo_linr.bias&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=ln>455</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>456</span><span class=cl>
</span></span><span class=line><span class=ln>457</span><span class=cl>
</span></span><span class=line><span class=ln>458</span><span class=cl><span class=kd>function</span> <span class=nx>netForward</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>459</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>   <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>zeros</span><span class=p>()};</span>
</span></span><span class=line><span class=ln>460</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>   <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>s2</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>zeros</span><span class=p>()};</span>
</span></span><span class=line><span class=ln>461</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>16</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>  <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>c3</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>zeros</span><span class=p>()};</span>
</span></span><span class=line><span class=ln>462</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>16</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>  <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>s4</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>zeros</span><span class=p>()};</span>
</span></span><span class=line><span class=ln>463</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>1</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>   <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>c5</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>zeros</span><span class=p>()};</span>
</span></span><span class=line><span class=ln>464</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>1</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>   <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>f6</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>zeros</span><span class=p>()};</span>
</span></span><span class=line><span class=ln>465</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>1</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>   <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>fo</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>zeros</span><span class=p>()};</span>
</span></span><span class=line><span class=ln>466</span><span class=cl>
</span></span><span class=line><span class=ln>467</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>468</span><span class=cl>    <span class=nx>layers</span><span class=p>.</span><span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>conv2d</span><span class=p>.</span><span class=nx>forward</span><span class=p>(</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>ds28</span><span class=p>,</span> <span class=nx>buffers</span><span class=p>.</span><span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>469</span><span class=cl>    <span class=nx>buffers</span><span class=p>.</span><span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>add</span><span class=p>(</span><span class=nx>layers</span><span class=p>.</span><span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>bias</span><span class=p>);</span>
</span></span><span class=line><span class=ln>470</span><span class=cl>    <span class=nx>buffers</span><span class=p>.</span><span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>map</span><span class=p>(</span><span class=nx>Sigmoid</span><span class=p>);</span>
</span></span><span class=line><span class=ln>471</span><span class=cl>    <span class=nx>layers</span><span class=p>.</span><span class=nx>s2</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>pool2d</span><span class=p>.</span><span class=nx>forward</span><span class=p>(</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>buffers</span><span class=p>.</span><span class=nx>s2</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=ln>472</span><span class=cl>    <span class=nx>buffers</span><span class=p>.</span><span class=nx>s2</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>upscaleDilate</span><span class=p>(</span><span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2112</span><span class=p>)</span>
</span></span><span class=line><span class=ln>473</span><span class=cl>    <span class=nx>canvasSubRoutineDrawMatrix</span><span class=p>(</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>c1</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2120</span><span class=p>,</span> <span class=mi>240</span><span class=o>+</span><span class=mi>30</span><span class=o>+</span><span class=mi>25</span><span class=o>+</span><span class=p>(</span><span class=mi>122</span><span class=o>*</span><span class=nx>i</span><span class=p>),</span> <span class=mi>80</span><span class=p>);</span>
</span></span><span class=line><span class=ln>474</span><span class=cl>    <span class=nx>canvasSubRoutineDrawMatrix</span><span class=p>(</span><span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2112</span><span class=p>,</span> <span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2120</span><span class=p>,</span> <span class=mi>240</span><span class=o>+</span><span class=mi>30</span><span class=o>+</span><span class=mi>25</span><span class=o>+</span><span class=p>(</span><span class=mi>122</span><span class=o>*</span><span class=nx>i</span><span class=p>),</span> <span class=mi>260</span><span class=p>);</span>
</span></span><span class=line><span class=ln>475</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>476</span><span class=cl>
</span></span><span class=line><span class=ln>477</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>6</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>478</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>j</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>j</span><span class=o>&lt;</span><span class=mi>16</span><span class=p>;</span> <span class=nx>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>479</span><span class=cl>      <span class=nx>layers</span><span class=p>.</span><span class=nx>c3</span><span class=p>[</span><span class=nx>j</span><span class=p>][</span><span class=nx>i</span><span class=p>].</span><span class=nx>conv2d</span><span class=p>.</span><span class=nx>forward</span><span class=p>(</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>s2</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>buffers</span><span class=p>.</span><span class=nx>c3</span><span class=p>[</span><span class=nx>j</span><span class=p>])</span>
</span></span><span class=line><span class=ln>480</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>481</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>482</span><span class=cl>
</span></span><span class=line><span class=ln>483</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>j</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>j</span><span class=o>&lt;</span><span class=mi>16</span><span class=p>;</span> <span class=nx>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>484</span><span class=cl>    <span class=nx>buffers</span><span class=p>.</span><span class=nx>c3</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nx>add</span><span class=p>(</span><span class=nx>layers</span><span class=p>.</span><span class=nx>c3</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nx>bias</span><span class=p>)</span>
</span></span><span class=line><span class=ln>485</span><span class=cl>    <span class=nx>buffers</span><span class=p>.</span><span class=nx>c3</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nx>map</span><span class=p>(</span><span class=nx>Sigmoid</span><span class=p>)</span>
</span></span><span class=line><span class=ln>486</span><span class=cl>    <span class=nx>layers</span><span class=p>.</span><span class=nx>s4</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nx>pool2d</span><span class=p>.</span><span class=nx>forward</span><span class=p>(</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>c3</span><span class=p>[</span><span class=nx>j</span><span class=p>],</span> <span class=nx>buffers</span><span class=p>.</span><span class=nx>s4</span><span class=p>[</span><span class=nx>j</span><span class=p>])</span>
</span></span><span class=line><span class=ln>487</span><span class=cl>    <span class=nx>buffers</span><span class=p>.</span><span class=nx>s4</span><span class=p>[</span><span class=nx>j</span><span class=p>].</span><span class=nx>upscaleDilate</span><span class=p>(</span><span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2080</span><span class=p>)</span>
</span></span><span class=line><span class=ln>488</span><span class=cl>    <span class=nx>canvasSubRoutineDrawMatrix</span><span class=p>(</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>c3</span><span class=p>[</span><span class=nx>j</span><span class=p>],</span> <span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2100</span><span class=p>,</span> <span class=mi>30</span><span class=o>+</span><span class=p>(</span><span class=mi>122</span><span class=o>*</span><span class=p>(</span><span class=nx>j</span> <span class=o>%</span> <span class=mi>8</span><span class=p>)),</span> <span class=mi>470</span><span class=o>+</span><span class=mi>122</span><span class=o>*</span><span class=p>(</span><span class=nx>j</span><span class=o>&gt;</span><span class=mi>7</span><span class=o>?</span><span class=mi>1</span><span class=o>:</span><span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=ln>489</span><span class=cl>    <span class=nx>canvasSubRoutineDrawMatrix</span><span class=p>(</span><span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2080</span><span class=p>,</span> <span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2100</span><span class=p>,</span> <span class=mi>30</span><span class=o>+</span><span class=p>(</span><span class=mi>122</span><span class=o>*</span><span class=p>(</span><span class=nx>j</span> <span class=o>%</span> <span class=mi>8</span><span class=p>)),</span> <span class=mi>800</span><span class=o>+</span><span class=mi>122</span><span class=o>*</span><span class=p>(</span><span class=nx>j</span><span class=o>&gt;</span><span class=mi>7</span><span class=o>?</span><span class=mi>1</span><span class=o>:</span><span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=ln>490</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>491</span><span class=cl>
</span></span><span class=line><span class=ln>492</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>k</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>k</span><span class=o>&lt;</span><span class=mi>120</span><span class=p>;</span> <span class=nx>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>493</span><span class=cl>    <span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2001</span><span class=p>.</span><span class=nx>zeros</span><span class=p>();</span>
</span></span><span class=line><span class=ln>494</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>j</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>j</span><span class=o>&lt;</span><span class=mi>16</span><span class=p>;</span> <span class=nx>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>495</span><span class=cl>      <span class=nx>layers</span><span class=p>.</span><span class=nx>c5</span><span class=p>[</span><span class=nx>k</span><span class=p>][</span><span class=nx>j</span><span class=p>].</span><span class=nx>conv2d</span><span class=p>.</span><span class=nx>forward</span><span class=p>(</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>s4</span><span class=p>[</span><span class=nx>j</span><span class=p>],</span> <span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2001</span><span class=p>)</span>
</span></span><span class=line><span class=ln>496</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>497</span><span class=cl>    <span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2001</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>layers</span><span class=p>.</span><span class=nx>c5</span><span class=p>[</span><span class=nx>k</span><span class=p>].</span><span class=nx>bias</span><span class=p>);</span>
</span></span><span class=line><span class=ln>498</span><span class=cl>    <span class=nx>buffers</span><span class=p>.</span><span class=nx>c5</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>buf</span><span class=p>[</span><span class=nx>k</span><span class=p>]</span> <span class=o>=</span> <span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2001</span><span class=p>.</span><span class=nx>buf</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=ln>499</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>500</span><span class=cl>  <span class=nx>buffers</span><span class=p>.</span><span class=nx>c5</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>map</span><span class=p>(</span><span class=nx>Sigmoid</span><span class=p>);</span>
</span></span><span class=line><span class=ln>501</span><span class=cl>  <span class=nx>layers</span><span class=p>.</span><span class=nx>f6</span><span class=p>.</span><span class=nx>linear</span><span class=p>.</span><span class=nx>forward</span><span class=p>(</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>c5</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>buffers</span><span class=p>.</span><span class=nx>f6</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>502</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>84</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>f6</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>buf</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>+=</span> <span class=nx>layers</span><span class=p>.</span><span class=nx>f6</span><span class=p>.</span><span class=nx>bias</span><span class=p>[</span><span class=nx>i</span><span class=p>]};</span>
</span></span><span class=line><span class=ln>503</span><span class=cl>  <span class=nx>buffers</span><span class=p>.</span><span class=nx>f6</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>map</span><span class=p>(</span><span class=nx>Sigmoid</span><span class=p>);</span>
</span></span><span class=line><span class=ln>504</span><span class=cl>  <span class=nx>layers</span><span class=p>.</span><span class=nx>fo</span><span class=p>.</span><span class=nx>linear</span><span class=p>.</span><span class=nx>forward</span><span class=p>(</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>f6</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>buffers</span><span class=p>.</span><span class=nx>fo</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>505</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=nx>i</span><span class=o>&lt;</span><span class=mi>10</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>fo</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>buf</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>+=</span> <span class=nx>layers</span><span class=p>.</span><span class=nx>fo</span><span class=p>.</span><span class=nx>bias</span><span class=p>[</span><span class=nx>i</span><span class=p>]};</span>
</span></span><span class=line><span class=ln>506</span><span class=cl>  <span class=nx>buffers</span><span class=p>.</span><span class=nx>fo</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>map</span><span class=p>(</span><span class=nx>Sigmoid</span><span class=p>);</span>
</span></span><span class=line><span class=ln>507</span><span class=cl>  <span class=nx>canvasSubRoutineDrawDense</span><span class=p>(</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>c5</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>1100</span><span class=o>+</span><span class=mi>260</span><span class=o>*</span><span class=mi>0</span><span class=p>,</span> <span class=nx>cvPt</span><span class=p>.</span><span class=nx>width</span><span class=o>-</span><span class=mi>30</span><span class=o>-</span><span class=mi>30</span><span class=p>,</span> <span class=mi>200</span><span class=p>);</span>
</span></span><span class=line><span class=ln>508</span><span class=cl>  <span class=nx>canvasSubRoutineDrawDense</span><span class=p>(</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>f6</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>1100</span><span class=o>+</span><span class=mi>260</span><span class=o>*</span><span class=mi>1</span><span class=p>,</span> <span class=nx>cvPt</span><span class=p>.</span><span class=nx>width</span><span class=o>-</span><span class=mi>30</span><span class=o>-</span><span class=mi>30</span><span class=p>,</span> <span class=mi>200</span><span class=p>);</span>
</span></span><span class=line><span class=ln>509</span><span class=cl>  <span class=nx>canvasSubRoutineDrawDense</span><span class=p>(</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>fo</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>1100</span><span class=o>+</span><span class=mi>260</span><span class=o>*</span><span class=mi>2</span><span class=p>,</span> <span class=nx>cvPt</span><span class=p>.</span><span class=nx>width</span><span class=o>-</span><span class=mi>30</span><span class=o>-</span><span class=mi>30</span><span class=p>,</span> <span class=mi>200</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=ln>510</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>511</span><span class=cl>
</span></span><span class=line><span class=ln>512</span><span class=cl>
</span></span><span class=line><span class=ln>513</span><span class=cl><span class=cm>/*  ==================== Entry point ==================== */</span>
</span></span><span class=line><span class=ln>514</span><span class=cl>
</span></span><span class=line><span class=ln>515</span><span class=cl><span class=kd>function</span> <span class=nx>connectCanvasCursorInput</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>516</span><span class=cl>  <span class=kd>function</span> <span class=nx>cursorEventHandler</span><span class=p>(</span><span class=nx>h</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>517</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nx>flag</span> <span class=o>&amp;</span> <span class=nx>h</span><span class=p>.</span><span class=nx>flags</span><span class=p>.</span><span class=nx>down</span> <span class=o>||</span> <span class=nx>h</span><span class=p>.</span><span class=nx>flag</span> <span class=o>===</span> <span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nx>flags</span><span class=p>.</span><span class=nx>down</span> <span class=o>|</span> <span class=nx>h</span><span class=p>.</span><span class=nx>flags</span><span class=p>.</span><span class=nx>move</span><span class=p>)){</span>
</span></span><span class=line><span class=ln>518</span><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>x</span> <span class=o>==</span> <span class=nx>h</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>prev</span><span class=p>.</span><span class=nx>x</span> <span class=o>&amp;&amp;</span> <span class=nx>h</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>y</span> <span class=o>==</span> <span class=nx>h</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>prev</span><span class=p>.</span><span class=nx>y</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>519</span><span class=cl>        <span class=nx>canvasSubRoutineDrawDot</span><span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>x</span><span class=p>,</span> <span class=nx>h</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln>520</span><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>521</span><span class=cl>        <span class=nx>canvasSubRoutineDrawLine</span><span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>prev</span><span class=p>.</span><span class=nx>x</span><span class=p>,</span> <span class=nx>h</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>prev</span><span class=p>.</span><span class=nx>y</span><span class=p>,</span> <span class=nx>h</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>x</span><span class=p>,</span> <span class=nx>h</span><span class=p>.</span><span class=nx>pos</span><span class=p>.</span><span class=nx>curr</span><span class=p>.</span><span class=nx>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln>522</span><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=ln>523</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>524</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>h</span><span class=p>.</span><span class=nx>flag</span> <span class=o>===</span> <span class=nx>h</span><span class=p>.</span><span class=nx>flags</span><span class=p>.</span><span class=nx>idle</span><span class=p>){</span>
</span></span><span class=line><span class=ln>525</span><span class=cl>      <span class=nx>appUpdate</span><span class=p>();</span>
</span></span><span class=line><span class=ln>526</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>527</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>528</span><span class=cl>  <span class=nx>cursorHandler</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>cCursorHandler</span><span class=p>(</span><span class=nx>cvIn</span><span class=p>,</span> <span class=nx>cursorEventHandler</span><span class=p>);</span>
</span></span><span class=line><span class=ln>529</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>530</span><span class=cl>
</span></span><span class=line><span class=ln>531</span><span class=cl><span class=kd>function</span> <span class=nx>disconnectCanvasCursorInput</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>532</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>cursorHandler</span> <span class=o>!==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>533</span><span class=cl>    <span class=nx>cursorHandler</span><span class=p>.</span><span class=nx>detach</span><span class=p>();</span>
</span></span><span class=line><span class=ln>534</span><span class=cl>    <span class=nx>cursorHandler</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=ln>535</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>536</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>537</span><span class=cl>
</span></span><span class=line><span class=ln>538</span><span class=cl><span class=kd>function</span> <span class=nx>appInit</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>539</span><span class=cl>  <span class=nx>disconnectCanvasCursorInput</span><span class=p>();</span>
</span></span><span class=line><span class=ln>540</span><span class=cl>  <span class=nx>connectCanvasCursorInput</span><span class=p>();</span>
</span></span><span class=line><span class=ln>541</span><span class=cl>  <span class=nx>appInCanvasReset</span><span class=p>();</span>
</span></span><span class=line><span class=ln>542</span><span class=cl>  <span class=nx>netInit</span><span class=p>();</span>
</span></span><span class=line><span class=ln>543</span><span class=cl>  <span class=nx>appUpdate</span><span class=p>();</span>
</span></span><span class=line><span class=ln>544</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>545</span><span class=cl>
</span></span><span class=line><span class=ln>546</span><span class=cl>
</span></span><span class=line><span class=ln>547</span><span class=cl><span class=kd>function</span> <span class=nx>appUpdate</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>548</span><span class=cl>  <span class=kr>const</span> <span class=nx>imd</span> <span class=o>=</span> <span class=nx>cvInCtx</span><span class=p>.</span><span class=nx>getImageData</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nx>cvIn</span><span class=p>.</span><span class=nx>width</span><span class=p>,</span><span class=nx>cvIn</span><span class=p>.</span><span class=nx>height</span><span class=p>);</span>
</span></span><span class=line><span class=ln>549</span><span class=cl>  <span class=nx>buffers</span><span class=p>.</span><span class=nx>input</span><span class=p>.</span><span class=nx>loadImageData</span><span class=p>(</span><span class=nx>imd</span><span class=p>.</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=ln>550</span><span class=cl>  <span class=nx>Interp</span><span class=p>.</span><span class=nx>bilinear_m</span><span class=p>(</span><span class=nx>buffers</span><span class=p>.</span><span class=nx>input</span><span class=p>,</span> <span class=nx>buffers</span><span class=p>.</span><span class=nx>ds28</span><span class=p>);</span>
</span></span><span class=line><span class=ln>551</span><span class=cl>  <span class=nx>buffers</span><span class=p>.</span><span class=nx>ds28</span><span class=p>.</span><span class=nx>upscaleDilate</span><span class=p>(</span><span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2112</span><span class=p>)</span>
</span></span><span class=line><span class=ln>552</span><span class=cl>  <span class=nx>canvasSubRoutineDrawMatrix</span><span class=p>(</span><span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2112</span><span class=p>,</span> <span class=nx>tmp_buf</span><span class=p>.</span><span class=nx>m2240</span><span class=p>,</span> <span class=mi>30</span><span class=p>,</span> <span class=mi>80</span><span class=p>);</span>
</span></span><span class=line><span class=ln>553</span><span class=cl>  <span class=nx>netForward</span><span class=p>();</span>
</span></span><span class=line><span class=ln>554</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>555</span><span class=cl>
</span></span><span class=line><span class=ln>556</span><span class=cl>
</span></span><span class=line><span class=ln>557</span><span class=cl><span class=nx>fetch</span><span class=p>(</span><span class=s1>&#39;./assets/LeNet5.json&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>558</span><span class=cl><span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>resp</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=ln>559</span><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>resp</span><span class=p>.</span><span class=nx>status</span><span class=p>,</span> <span class=nx>resp</span><span class=p>.</span><span class=nx>url</span><span class=p>);</span>
</span></span><span class=line><span class=ln>560</span><span class=cl>  <span class=nx>resp</span><span class=p>.</span><span class=nx>json</span><span class=p>()</span>
</span></span><span class=line><span class=ln>561</span><span class=cl>  <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>d</span><span class=p>)=&gt;{</span>
</span></span><span class=line><span class=ln>562</span><span class=cl>    <span class=nx>data</span> <span class=o>=</span> <span class=nx>d</span><span class=p>;</span>
</span></span><span class=line><span class=ln>563</span><span class=cl>    <span class=nb>document</span><span class=p>.</span><span class=nx>getElementById</span><span class=p>(</span><span class=s2>&#34;appInCanvasReset&#34;</span><span class=p>).</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;click&#34;</span><span class=p>,</span> <span class=p>(</span><span class=nx>e</span><span class=p>)=&gt;{</span><span class=nx>appInCanvasReset</span><span class=p>();</span><span class=nx>appUpdate</span><span class=p>()})</span>
</span></span><span class=line><span class=ln>564</span><span class=cl>    <span class=nx>appInit</span><span class=p>();</span>
</span></span><span class=line><span class=ln>565</span><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=ln>566</span><span class=cl>  <span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=ln>567</span><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=ln>568</span><span class=cl><span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=ln>569</span><span class=cl>
</span></span><span class=line><span class=ln>570</span><span class=cl>
</span></span><span class=line><span class=ln>571</span><span class=cl><span class=p>}</span></span></span></code></pre></div><script defer>window.onload=function(){const r=document.getElementById("Input"),n=r.getContext("2d",{alpha:!1}),c=document.getElementById("Viewport"),e=c.getContext("2d",{alpha:!1}),l=e=>~~e;var h=null,i=null;class O{flags={idle:0,move:1,down:2};constructor(e,t=e=>{}){this.el=e,this.cb=t,this.w=e.width,this.h=e.height,this.flag=this.flags.idle,this.pos={},this.pos.curr={x:0,y:0},this.pos.prev={x:0,y:0},this.ratio={},this.ratio.curr={x:0,y:0},this.ratio.prev={x:0,y:0},this.handleMove=e=>{this.update(e),this.flag|=this.flags.move,this.cb(this)},this.handleDown=e=>{this.update(e),this.update(e),this.flag|=this.flags.down,this.cb(this)},this.handleUp=e=>{this.update(e),this.flag=this.flags.idle,this.cb(this)},this.el.addEventListener("pointermove",this.handleMove),this.el.addEventListener("pointerdown",this.handleDown),this.el.addEventListener("pointerup",this.handleUp),this.el.addEventListener("pointercancel",this.handleUp)}update(e){let t=this.el.getBoundingClientRect();this.pos.prev.x=this.pos.curr.x,this.pos.prev.y=this.pos.curr.y,this.ratio.prev.x=this.ratio.curr.x,this.ratio.prev.y=this.ratio.curr.y,this.ratio.curr.x=(e.clientX-t.left)/t.width,this.ratio.curr.y=(e.clientY-t.top)/t.height,this.pos.curr.x=l(this.ratio.curr.x*this.w),this.pos.curr.y=l(this.ratio.curr.y*this.h)}detach(){this.el.removeEventListener("pointermove",this.handleMove),this.el.removeEventListener("pointerdown",this.handleDown),this.el.removeEventListener("pointerup",this.handleUp),this.el.removeEventListener("pointercancel",this.handleUp)}}class o{static bi_loop(e,t,n,s,o){let m,f,r,c,p,g,i,a,l,u,d,h;r=(e-2)/(n-1),c=(t-2)/(s-1);for(i=0;i<n;i++)for(a=0;a<s;a++)l=Math.floor(r*i),u=Math.ceil(r*i),d=Math.floor(c*a),h=Math.ceil(c*a),o(i,a,l,u,d,h,r*i-l,c*a-d)}static bi_invoke(e,t,n){o.bi_loop(e.w,e.h,t.w,t.h,(s,o,i,a,r,c,l,d)=>{if(s<0||s>=t.w||o<0||o>=t.h)return;if(i<0||i>=e.w||r<0||r>=e.h)return;if(a<0||a>=e.w||c<0||c>=e.h)return;t.set(s,o,n(e.get(i,r),e.get(a,r),e.get(i,c),e.get(a,c),l,d))})}static nearest(e,t,n){return n>=.5?t:e}static binearest(e,t,n,s,i,a){return o.nearest(o.nearest(e,t,i),o.nearest(n,s,i),a)}static binearest_m(e,t){o.bi_invoke(e,t,o.binearest)}static linear(e,t,n){return e+(t-e)*n}static bilinear(e,t,n,s,i,a){return o.linear(o.linear(e,t,i),o.linear(n,s,i),a)}static bilinear_m(e,t){o.bi_invoke(e,t,o.bilinear)}}class s{constructor(e,t){this.w=e,this.h=t,this.l=e*t,this.buf=new Float32Array(this.l)}itox(e){return e%this.w}itoy(e){return l(e/this.w)}ctoi(e,t){return e+t*this.w}get(e,t){return this.buf[this.ctoi(e,t)]}set(e,t,n){this.buf[this.ctoi(e,t)]=n}add(e){for(let t=0;t<this.l;t++)this.buf[t]=this.buf[t]+e}mul(e){for(let t=0;t<this.l;t++)this.buf[t]=this.buf[t]*e}map(e){for(let t=0;t<this.l;t++)this.buf[t]=e(this.buf[t])}zeros(){for(let e=0;e<this.buf.length;e++)this.buf[e]=0}getMin(){return Math.min(...this.buf)}getMax(){return Math.max(...this.buf)}load2DArray(e){for(let t=0;t<this.w;t++)for(let n=0;n<this.h;n++)this.set(t,n,e[n][t])}loadImageData(e){for(let t=0;t<e.length;t+=4)this.buf[l(t/4)]=(e[t+0]+e[t+1]+e[t+2])/3/255}unloadImageData(e){for(let n=0;n<e.length;n+=4){let t=this.buf[l(n/4)];t=t>1?1:t,t=t<0?0:t,t=l(t*255),e[n+0]=t,e[n+1]=t,e[n+2]=t}}upscaleDilate(e){let t=l(e.w/this.w);for(let n=0;n<this.w;n++)for(let s=0;s<this.h;s++)for(let o=0;o<t;o++)for(let i=0;i<t;i++)e.set(n*t+o,s*t+i,this.get(n,s))}}function d(e){return 1/(1+Math.exp(-e))}function M(e){return e<0?0:e}function m(e,t,n,s){return Math.floor((e+t*2-(n-1)-1)/s+1)}function b(e,t,n,s,o,i,a,r,c,l,d){if(n!==m(e,a,o,c))throw console.error(n,m(e,a,o,c)),"Invalid Output Matrix Size";if(s!==m(t,r,i,l))throw console.error(s,m(t,r,i,l)),"Invalid Output Matrix Size";let u,h,f,p;for(u=0;u<n;u++)for(h=0;h<s;h++)for(f=0;f<o;f++)for(p=0;p<i;p++)d(u,h,f,p,u*c+f-(a||0),h*l+p-(r||0))}class p{constructor(e,t,n){this.kernel=e,this.stride=t||1,this.padding=n||0}forward(e,t){b(e.w,e.h,t.w,t.h,this.kernel[0].length,this.kernel.length,this.padding,this.padding,this.stride,this.stride,(n,s,o,i,a,r)=>{t.set(n,s,t.get(n,s)+(e.get(a,r)||0)*this.kernel[i][o])})}}class w{constructor(e,t,n,s){this.w=e,this.h=t,this.stride=n||1,this.padding=s||0}forward(e,t){t.zeros(),t.add(-1e31),b(e.w,e.h,t.w,t.h,this.w,this.h,this.padding,this.padding,this.stride,this.stride,(n,s,o,i,a,r)=>{t.set(n,s,Math.max(t.get(n,s),e.get(a,r)||0))})}}class j{constructor(e){this.A=e}forward(e,t){for(let n=0;n<this.A[0].length;n++)for(let s=0;s<this.A.length;s++)t.buf[s]+=e.buf[n]*this.A[s][n]}}function S(e,t){n.fillStyle="white",n.filter="blur(5px)",n.beginPath(),n.arc(e,t,14,0,2*Math.PI),n.fill()}function E(e,t,s,o){n.strokeStyle="white",n.filter="blur(5px)",n.lineWidth=28,n.lineCap="round",n.beginPath(),n.moveTo(e,t),n.lineTo(s,o),n.stroke()}function a(t,n,s,o){e.save(),e.fillStyle="black",e.font="32px monospace",e.textBaseline="middle",e.textAlign=o||"left",e.fillText(s,t,n)}function u(t,n,s,i,a){const r=e.getImageData(s,i,n.w,n.h);if(o.binearest_m(t,n),a||!0){let e=n.getMin(),t=n.getMax();n.add(-e),n.mul(1/(t-e))}n.unloadImageData(r.data),e.putImageData(r,s,i),e.strokeStyle="blue",e.rect(s-2,i-2,n.w+4,n.h+4),e.stroke()}function f(t,n,s,o,i,r){e.save();let c=o/t.w;e.fillStyle="white",e.strokeStyle="black",e.beginPath(),e.rect(n,s,o,i),e.fill();for(let o=0;o<t.w;o++)e.rect(n+c*o,s,c,i);e.stroke();for(let o=0;o<t.w;o++){let l=i*(1-t.buf[o]);e.fillStyle="blue",e.fillRect(n+c*o,s+l,c,i-l),(r||!1)&&a(n+c*o+c/2,s+i+32,""+o,"center")}e.restore()}function _(){a(150,30,"input(512x512)","center"),a(150,60,"downsamp(28x28)","center"),a(300,80-20,"C1: Conv2D 5x5pad2 (28x28) x6 (Sigmoid)","left"),a(300,260-20,"S2: MaxPool 2x2stride2 (14x14) x6","left"),a(30,470-20,"C3: Conv2D 5x5 (10x10) x16 (Sigmoid)","left"),a(30,800-20,"S4: MaxPool 2x2stride2 (5x5) x16","left"),a(30,1076+260*0,"C5: Conv2D 5x5 (1x1) x120 Flatten (Sigmoid)","left"),a(30,1076+260*1,"F6: Linear (84x120) (Sigmoid)","left"),a(30,1076+260*2,"F0: Linear (10x84) (Sigmoid)","left")}function v(){n.fillStyle="black",n.clearRect(0,0,r.width,r.height),n.fillRect(0,0,r.width,r.height),e.save(),e.fillStyle="white",e.clearRect(0,0,c.width,c.height),e.fillRect(0,0,c.width,c.height),_()}const t={};t.m2080=new s(80,80),t.m2100=new s(100,100),t.m2112=new s(112,112),t.m2120=new s(120,120),t.m2240=new s(240,240),t.m2001=new s(1,1),layers={},buffers={},buffers.input=new s(r.width,r.height),buffers.ds28=new s(28,28);function x(){const e=new w(2,2,2,0);buffers.c1={},buffers.s2={},buffers.c3={},buffers.s4={},buffers.c5={},buffers.f6={},buffers.fo={};for(let e=0;e<6;e++)buffers.c1[e]=new s(28,28);for(let e=0;e<6;e++)buffers.s2[e]=new s(14,14);for(let e=0;e<16;e++)buffers.c3[e]=new s(10,10);for(let e=0;e<16;e++)buffers.s4[e]=new s(5,5);for(let e=0;e<1;e++)buffers.c5[e]=new s(120,1);for(let e=0;e<1;e++)buffers.f6[e]=new s(84,1);for(let e=0;e<1;e++)buffers.fo[e]=new s(10,1);layers.c1={},layers.s2={};for(let t=0;t<6;t++)layers.c1[t]={},layers.c1[t].conv2d=new p(i["c1_conv.weight"][t][0],1,2),layers.c1[t].bias=i["c1_conv.bias"][t],layers.s2[t]={},layers.s2[t].pool2d=e;layers.c3={},layers.s4={};for(let t=0;t<16;t++){layers.c3[t]={},layers.c3[t].bias=i["c3_conv.bias"][t],layers.s4[t]={},layers.s4[t].pool2d=e;for(let e=0;e<6;e++)layers.c3[t][e]={},layers.c3[t][e].conv2d=new p(i["c3_conv.weight"][t][e],1,0)}layers.c5={};for(let e=0;e<120;e++){layers.c5[e]={},layers.c5[e].bias=i["c5_conv.bias"][e];for(let t=0;t<16;t++)layers.c5[e][t]={},layers.c5[e][t].conv2d=new p(i["c5_conv.weight"][e][t],1,0)}layers.f6={},layers.f6.linear=new j(i["f6_linr.weight"]),layers.f6.bias=i["f6_linr.bias"],layers.fo={},layers.fo.linear=new j(i["fo_linr.weight"]),layers.fo.bias=i["fo_linr.bias"]}function C(){for(let e=0;e<6;e++)buffers.c1[e].zeros();for(let e=0;e<6;e++)buffers.s2[e].zeros();for(let e=0;e<16;e++)buffers.c3[e].zeros();for(let e=0;e<16;e++)buffers.s4[e].zeros();for(let e=0;e<1;e++)buffers.c5[e].zeros();for(let e=0;e<1;e++)buffers.f6[e].zeros();for(let e=0;e<1;e++)buffers.fo[e].zeros();for(let e=0;e<6;e++)layers.c1[e].conv2d.forward(buffers.ds28,buffers.c1[e]),buffers.c1[e].add(layers.c1[e].bias),buffers.c1[e].map(d),layers.s2[e].pool2d.forward(buffers.c1[e],buffers.s2[e]),buffers.s2[e].upscaleDilate(t.m2112),u(buffers.c1[e],t.m2120,240+30+25+122*e,80),u(t.m2112,t.m2120,240+30+25+122*e,260);for(let e=0;e<6;e++)for(let t=0;t<16;t++)layers.c3[t][e].conv2d.forward(buffers.s2[e],buffers.c3[t]);for(let e=0;e<16;e++)buffers.c3[e].add(layers.c3[e].bias),buffers.c3[e].map(d),layers.s4[e].pool2d.forward(buffers.c3[e],buffers.s4[e]),buffers.s4[e].upscaleDilate(t.m2080),u(buffers.c3[e],t.m2100,30+122*(e%8),470+122*(e>7?1:0)),u(t.m2080,t.m2100,30+122*(e%8),800+122*(e>7?1:0));for(let e=0;e<120;e++){t.m2001.zeros();for(let n=0;n<16;n++)layers.c5[e][n].conv2d.forward(buffers.s4[n],t.m2001);t.m2001.add(layers.c5[e].bias),buffers.c5[0].buf[e]=t.m2001.buf[0]}buffers.c5[0].map(d),layers.f6.linear.forward(buffers.c5[0],buffers.f6[0]);for(let e=0;e<84;e++)buffers.f6[0].buf[e]+=layers.f6.bias[e];buffers.f6[0].map(d),layers.fo.linear.forward(buffers.f6[0],buffers.fo[0]);for(let e=0;e<10;e++)buffers.fo[0].buf[e]+=layers.fo.bias[e];buffers.fo[0].map(d),f(buffers.c5[0],30,1100+260*0,c.width-30-30,200),f(buffers.f6[0],30,1100+260*1,c.width-30-30,200),f(buffers.fo[0],30,1100+260*2,c.width-30-30,200,!0)}function y(){function e(e){(e.flag&e.flags.down||e.flag===(e.flags.down|e.flags.move))&&(e.pos.curr.x==e.pos.prev.x&&e.pos.curr.y==e.pos.prev.y?S(e.pos.curr.x,e.pos.curr.y):E(e.pos.prev.x,e.pos.prev.y,e.pos.curr.x,e.pos.curr.y)),e.flag===e.flags.idle&&g()}h=new O(r,e)}function k(){h!==null&&(h.detach(),h=null)}function A(){k(),y(),v(),x(),g()}function g(){const e=n.getImageData(0,0,r.width,r.height);buffers.input.loadImageData(e.data),o.bilinear_m(buffers.input,buffers.ds28),buffers.ds28.upscaleDilate(t.m2112),u(t.m2112,t.m2240,30,80),C()}fetch("./assets/LeNet5.json").then(e=>{console.log(e.status,e.url),e.json().then(e=>{i=e,document.getElementById("appInCanvasReset").addEventListener("click",e=>{v(),g()}),A()}).catch(console.error)}).catch(console.error)}</script></div><br><br><br><br><p class=tc>Built with <a a target=_blank class=extern href=https://gohugo.io/>Hugo</a> | previoip (c) 2025</p></body></html>