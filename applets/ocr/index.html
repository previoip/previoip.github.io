<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-8HTK24ZVY8"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-8HTK24ZVY8');
        }
      </script>
    
  


<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/css/highlight.css?v=1.0.0">
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">







<style>:root{--f:1em;--w:30}html{margin:0 2em;max-width:calc(var(--f)*var(--w));font-size:var(--f)}body{margin:0;padding:0;font-family:monospace;scrollbar-face-color:ThreeDFace!important;scrollbar-shadow-color:ThreeDDarkShadow!important;scrollbar-highlight-color:ThreeDHighlight!important;scrollbar-3dlight-color:ThreeDLightShadow!important;scrollbar-darkshadow-color:ThreeDDarkShadow!important;scrollbar-track-color:Scrollbar!important;scrollbar-arrow-color:ButtonText!important}small{font-size:calc(var(--f)*.82)}*{font-size:inherit}p{padding-left:calc(var(--f)*1.6)}p canvas{outline:1px solid #000;width:calc(100% - var(--f)*1.6)}a{color:#1c69e5;text-decoration:underline}a:hover{color:#2072f5;text-decoration:none}a:active{color:#0062ff;text-decoration:none;background-color:var(--tx-c-hover)}blockquote{opacity:.75;background-color:#e9e61c68}div.mermaid .edgeLabel{padding:.2rem}img,div.mermaid svg{margin:auto;display:block;max-width:min(100%,calc(var(--f)*var(--w)));min-width:100px;background-color:#282a36;border-radius:.6rem}code:not([class]){background-color:#8e98d575;padding:0 .2em;border-radius:.2em}div.highlight pre{padding:1rem;border-radius:.6rem;overflow:scroll;overflow-y:auto;overflow-x:auto}div.highlight pre code span{margin-block-end:.1em}.disabled,.failed{pointer-events:none}.tc{padding-left:0;padding-right:0;text-align:center}.o50{opacity:.5}::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:#43454ce6;border-radius:3px}::-webkit-scrollbar-thumb{background:#c1cdf6e6;border-radius:3px}input,select{font:inherit}#control div{display:flex;align-items:center;margin-top:.6em}#control input,#control select{display:inline-block;margin:0 .5em}#control p{margin:0;width:2rem}</style>


  <title>
LeNet demo &ndash; dumb by default
</title>
</head>

<body><div style="background-color: #69696969;">
  <br>
  <h1 class="tc">dumb by default</h1>
  
<nav class="tc">
[<a href="/">Home</a>]&nbsp;[<a href="/about/">About</a>]&nbsp;[<a href="/posts/">Posts</a>]&nbsp;[<a href="/resources/">Resources</a>]&nbsp;[<a href="/applets/">Applets</a>]&nbsp;
</nav><hr>
</div><p style="padding: 0;">


<span>dir: <i>








<a href="/">Home</a> &sol;






<a href="/applets/">Applets</a> &sol;






<span>LeNet demo</span>

</i></span>




      <br>
      
      
      
      <span>published-date: 31 May 2025 14:25 &#43;0700</span><br>
      
      
      
       
<span>
  categories: [<a href="http://localhost:1313/categories/misc/">misc</a>]</span>
<br>
       
<span>
  tags: [<a href="http://localhost:1313/tags/"></a>]</span>
<br>    
    </p>
  <h1 class="tc">LeNet demo</h1>
  <hr>
  <div>
    

<div id="control">
<input id="canvasClear" type="button" value="clear">
</div>

<h1 id="canvas" class="tc">
<br>canvas
</h1><p><canvas id="canvasInput"  width=512 height=512></canvas></p>

<h1 id="immediate-output" class="tc">
<br>immediate output
</h1><p><canvas id="canvasVisual" width=1080 height=1920></canvas></p>

<div class="highlight" inject="true"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="ln">  1</span><span class="cl"><span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">  2</span><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="ln">  3</span><span class="cl">
</span></span><span class="line"><span class="ln">  4</span><span class="cl"><span class="kr">const</span> <span class="nx">canvasInput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;canvasInput&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">  5</span><span class="cl"><span class="kr">const</span> <span class="nx">canvasInputCtx</span> <span class="o">=</span> <span class="nx">canvasInput</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&#34;2d&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;alpha&#34;</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
</span></span><span class="line"><span class="ln">  6</span><span class="cl"><span class="kr">const</span> <span class="nx">canvasVisual</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;canvasVisual&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">  7</span><span class="cl"><span class="kr">const</span> <span class="nx">canvasVisualCtx</span> <span class="o">=</span> <span class="nx">canvasVisual</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&#34;2d&#34;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;alpha&#34;</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
</span></span><span class="line"><span class="ln">  8</span><span class="cl"><span class="kr">const</span> <span class="nx">ftoi</span> <span class="o">=</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="o">~~</span><span class="nx">v</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">  9</span><span class="cl"><span class="kr">const</span> <span class="nx">arrcp</span> <span class="o">=</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">dst</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">src</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">dst</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">=</span><span class="nx">src</span><span class="p">[</span><span class="nx">i</span><span class="p">]}}</span>
</span></span><span class="line"><span class="ln"> 10</span><span class="cl">
</span></span><span class="line"><span class="ln"> 11</span><span class="cl">
</span></span><span class="line"><span class="ln"> 12</span><span class="cl"><span class="kr">class</span> <span class="nx">Interpolations</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 13</span><span class="cl">
</span></span><span class="line"><span class="ln"> 14</span><span class="cl">  <span class="kr">static</span> <span class="nx">nearest</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 15</span><span class="cl">    <span class="k">return</span> <span class="nx">t</span> <span class="o">&gt;=</span> <span class="p">.</span><span class="mi">5</span> <span class="o">?</span> <span class="nx">b</span> <span class="o">:</span> <span class="nx">a</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 16</span><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="ln"> 17</span><span class="cl">
</span></span><span class="line"><span class="ln"> 18</span><span class="cl">  <span class="kr">static</span> <span class="nx">linear</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 19</span><span class="cl">    <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="p">(</span><span class="nx">b</span> <span class="o">-</span> <span class="nx">a</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span>
</span></span><span class="line"><span class="ln"> 20</span><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="ln"> 21</span><span class="cl">
</span></span><span class="line"><span class="ln"> 22</span><span class="cl">  <span class="kr">static</span> <span class="nx">bilinear</span><span class="p">(</span><span class="nx">a1</span><span class="p">,</span> <span class="nx">b1</span><span class="p">,</span> <span class="nx">a2</span><span class="p">,</span> <span class="nx">b2</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="nx">t2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 23</span><span class="cl">    <span class="k">return</span> <span class="nx">Interpolations</span><span class="p">.</span><span class="nx">linear</span><span class="p">(</span>
</span></span><span class="line"><span class="ln"> 24</span><span class="cl">      <span class="nx">Interpolations</span><span class="p">.</span><span class="nx">linear</span><span class="p">(</span><span class="nx">a1</span><span class="p">,</span> <span class="nx">b1</span><span class="p">,</span> <span class="nx">t1</span><span class="p">),</span>
</span></span><span class="line"><span class="ln"> 25</span><span class="cl">      <span class="nx">Interpolations</span><span class="p">.</span><span class="nx">linear</span><span class="p">(</span><span class="nx">a2</span><span class="p">,</span> <span class="nx">b2</span><span class="p">,</span> <span class="nx">t1</span><span class="p">),</span>
</span></span><span class="line"><span class="ln"> 26</span><span class="cl">      <span class="nx">t2</span>
</span></span><span class="line"><span class="ln"> 27</span><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="ln"> 28</span><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="ln"> 29</span><span class="cl">
</span></span><span class="line"><span class="ln"> 30</span><span class="cl">  <span class="kr">static</span> <span class="nx">bilinear_a</span><span class="p">(</span><span class="nx">arrDst</span><span class="p">,</span> <span class="nx">wDst</span><span class="p">,</span> <span class="nx">hDst</span><span class="p">,</span> <span class="nx">arrSrc</span><span class="p">,</span> <span class="nx">wSrc</span><span class="p">,</span> <span class="nx">hSrc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 31</span><span class="cl">    <span class="kd">let</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ax</span><span class="p">,</span> <span class="nx">ay</span><span class="p">,</span> <span class="nx">bx</span><span class="p">,</span> <span class="nx">by</span><span class="p">,</span> <span class="nx">rx</span><span class="p">,</span> <span class="nx">ry</span><span class="p">,</span> <span class="nx">bi0</span><span class="p">,</span> <span class="nx">bi1</span><span class="p">,</span> <span class="nx">bi2</span><span class="p">,</span> <span class="nx">bi3</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 32</span><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">arrDst</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 33</span><span class="cl">      <span class="nx">ax</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">%</span> <span class="nx">wDst</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 34</span><span class="cl">      <span class="nx">ay</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">i</span> <span class="o">/</span> <span class="nx">wDst</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 35</span><span class="cl">      <span class="nx">rx</span> <span class="o">=</span> <span class="nx">ax</span> <span class="o">/</span> <span class="nx">wDst</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 36</span><span class="cl">      <span class="nx">ry</span> <span class="o">=</span> <span class="nx">ay</span> <span class="o">/</span> <span class="nx">hDst</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 37</span><span class="cl">      <span class="nx">bx</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">rx</span> <span class="o">*</span> <span class="p">(</span><span class="nx">hSrc</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="ln"> 38</span><span class="cl">      <span class="nx">by</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">ry</span> <span class="o">*</span> <span class="p">(</span><span class="nx">wSrc</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="ln"> 39</span><span class="cl">      <span class="nx">rx</span> <span class="o">%=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 40</span><span class="cl">      <span class="nx">ry</span> <span class="o">%=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 41</span><span class="cl">      <span class="nx">arrDst</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Interpolations</span><span class="p">.</span><span class="nx">bilinear</span><span class="p">(</span>
</span></span><span class="line"><span class="ln"> 42</span><span class="cl">        <span class="nx">arrSrc</span><span class="p">[</span><span class="nx">bx</span><span class="o">+</span><span class="nx">wSrc</span><span class="o">*</span><span class="nx">by</span><span class="p">],</span>     <span class="nx">arrSrc</span><span class="p">[(</span><span class="nx">bx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="nx">wSrc</span><span class="o">*</span><span class="nx">by</span><span class="p">],</span>
</span></span><span class="line"><span class="ln"> 43</span><span class="cl">        <span class="nx">arrSrc</span><span class="p">[</span><span class="nx">bx</span><span class="o">+</span><span class="nx">wSrc</span><span class="o">*</span><span class="p">(</span><span class="nx">by</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span> <span class="nx">arrSrc</span><span class="p">[(</span><span class="nx">bx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="nx">wSrc</span><span class="o">*</span><span class="p">(</span><span class="nx">by</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span>
</span></span><span class="line"><span class="ln"> 44</span><span class="cl">        <span class="nx">rx</span><span class="p">,</span> <span class="nx">ry</span>
</span></span><span class="line"><span class="ln"> 45</span><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="ln"> 46</span><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="ln"> 47</span><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="ln"> 48</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 49</span><span class="cl">
</span></span><span class="line"><span class="ln"> 50</span><span class="cl">
</span></span><span class="line"><span class="ln"> 51</span><span class="cl"><span class="kr">class</span> <span class="nx">cFloat32Matrix2D</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 52</span><span class="cl">  <span class="nx">constructor</span> <span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 53</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">w</span> <span class="o">=</span> <span class="nx">w</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">h</span> <span class="o">=</span> <span class="nx">h</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">l</span> <span class="o">=</span> <span class="nx">w</span><span class="o">*</span><span class="nx">h</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 54</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">l</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 55</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 56</span><span class="cl">  <span class="nx">itox</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">i</span> <span class="o">%</span> <span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="p">};</span>
</span></span><span class="line"><span class="ln"> 57</span><span class="cl">  <span class="nx">itoy</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">i</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="p">)};</span>
</span></span><span class="line"><span class="ln"> 58</span><span class="cl">  <span class="nx">ctoi</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="p">(</span><span class="nx">y</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="p">)};</span>
</span></span><span class="line"><span class="ln"> 59</span><span class="cl">  <span class="nx">get</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">buf</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">ctoi</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)]};</span>
</span></span><span class="line"><span class="ln"> 60</span><span class="cl">  <span class="nx">set</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">buf</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">ctoi</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;};</span>
</span></span><span class="line"><span class="ln"> 61</span><span class="cl">  <span class="nx">zeros</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 62</span><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">buf</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 63</span><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">buf</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 64</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 65</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 66</span><span class="cl">  <span class="nx">loadImageData</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 67</span><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 68</span><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">buf</span><span class="p">[</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">i</span><span class="o">/</span><span class="mi">4</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">255</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 69</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 70</span><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="ln"> 71</span><span class="cl">  <span class="nx">unloadImageData</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 72</span><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 73</span><span class="cl">      <span class="kd">let</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buf</span><span class="p">[</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">i</span><span class="o">/</span><span class="mi">4</span><span class="p">)];</span>
</span></span><span class="line"><span class="ln"> 74</span><span class="cl">      <span class="nx">p</span> <span class="o">=</span> <span class="nx">p</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">p</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 75</span><span class="cl">      <span class="nx">p</span> <span class="o">=</span> <span class="nx">p</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">p</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 76</span><span class="cl">      <span class="nx">p</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span> <span class="mi">255</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 77</span><span class="cl">      <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 78</span><span class="cl">      <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 79</span><span class="cl">      <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
</span></span><span class="line"><span class="ln"> 80</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 81</span><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="ln"> 82</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 83</span><span class="cl">
</span></span><span class="line"><span class="ln"> 84</span><span class="cl"><span class="kr">const</span> <span class="nx">temp_buf</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="ln"> 85</span><span class="cl"><span class="nx">temp_buf</span><span class="p">.</span><span class="nx">f12</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cFloat32Matrix2D</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 86</span><span class="cl"><span class="nx">temp_buf</span><span class="p">.</span><span class="nx">f16</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cFloat32Matrix2D</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 87</span><span class="cl"><span class="nx">temp_buf</span><span class="p">.</span><span class="nx">f24</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cFloat32Matrix2D</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">240</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 88</span><span class="cl">
</span></span><span class="line"><span class="ln"> 89</span><span class="cl">
</span></span><span class="line"><span class="ln"> 90</span><span class="cl"><span class="c1">// LeNet setup
</span></span></span><span class="line"><span class="ln"> 91</span><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">buffers</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="ln"> 92</span><span class="cl"><span class="nx">buffers</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cFloat32Matrix2D</span><span class="p">(</span><span class="nx">canvasInput</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">canvasInput</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 93</span><span class="cl"><span class="nx">buffers</span><span class="p">.</span><span class="nx">ds32</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cFloat32Matrix2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 94</span><span class="cl">
</span></span><span class="line"><span class="ln"> 95</span><span class="cl">
</span></span><span class="line"><span class="ln"> 96</span><span class="cl"><span class="kd">function</span> <span class="nx">forward</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 97</span><span class="cl">  <span class="nx">Interpolations</span><span class="p">.</span><span class="nx">bilinear_a</span><span class="p">(</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">ds32</span><span class="p">.</span><span class="nx">buf</span><span class="p">,</span>  <span class="nx">buffers</span><span class="p">.</span><span class="nx">ds32</span><span class="p">.</span><span class="nx">w</span><span class="p">,</span>  <span class="nx">buffers</span><span class="p">.</span><span class="nx">ds32</span><span class="p">.</span><span class="nx">h</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 98</span><span class="cl">                            <span class="nx">buffers</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">buffers</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">w</span><span class="p">,</span> <span class="nx">buffers</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">h</span><span class="p">);</span>
</span></span><span class="line"><span class="ln"> 99</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">100</span><span class="cl">
</span></span><span class="line"><span class="ln">101</span><span class="cl">
</span></span><span class="line"><span class="ln">102</span><span class="cl">
</span></span><span class="line"><span class="ln">103</span><span class="cl"><span class="kr">class</span> <span class="nx">cCoo</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">104</span><span class="cl">  <span class="nx">constructor</span> <span class="p">(</span><span class="nx">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">y</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">105</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">106</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">107</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln">108</span><span class="cl">  <span class="nx">add</span><span class="p">(</span><span class="nx">coo</span><span class="p">)</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">coo</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">coo</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span> <span class="k">return</span> <span class="k">this</span><span class="p">};</span>
</span></span><span class="line"><span class="ln">109</span><span class="cl">  <span class="nx">sub</span><span class="p">(</span><span class="nx">coo</span><span class="p">)</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="nx">coo</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">-=</span> <span class="nx">coo</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span> <span class="k">return</span> <span class="k">this</span><span class="p">};</span>
</span></span><span class="line"><span class="ln">110</span><span class="cl">  <span class="nx">mul</span><span class="p">(</span><span class="nx">coo</span><span class="p">)</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">*=</span> <span class="nx">coo</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">*=</span> <span class="nx">coo</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span> <span class="k">return</span> <span class="k">this</span><span class="p">};</span>
</span></span><span class="line"><span class="ln">111</span><span class="cl">  <span class="nx">div</span><span class="p">(</span><span class="nx">coo</span><span class="p">)</span> <span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">/=</span> <span class="nx">coo</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">/=</span> <span class="nx">coo</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span> <span class="k">return</span> <span class="k">this</span><span class="p">};</span>
</span></span><span class="line"><span class="ln">112</span><span class="cl">  <span class="nx">copy_to</span><span class="p">(</span><span class="nx">coo</span><span class="p">)</span> <span class="p">{</span><span class="nx">coo</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span> <span class="nx">coo</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span> <span class="k">return</span> <span class="nx">coo</span><span class="p">};</span>
</span></span><span class="line"><span class="ln">113</span><span class="cl">  <span class="nx">eq</span><span class="p">(</span><span class="nx">coo</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">coo</span><span class="p">.</span><span class="nx">x</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">coo</span><span class="p">.</span><span class="nx">y</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">};</span>
</span></span><span class="line"><span class="ln">114</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">115</span><span class="cl">
</span></span><span class="line"><span class="ln">116</span><span class="cl"><span class="kr">class</span> <span class="nx">cCursorHandler</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">117</span><span class="cl">  <span class="nx">flags</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;idle&#39;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;move&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;down&#39;</span><span class="o">:</span> <span class="mi">2</span><span class="p">};</span>
</span></span><span class="line"><span class="ln">118</span><span class="cl">  <span class="nx">constructor</span> <span class="p">(</span><span class="nx">el</span><span class="p">,</span> <span class="nx">callback</span><span class="o">=</span><span class="p">(</span><span class="nx">handler</span><span class="p">)=&gt;{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">119</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">el</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">120</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">cb</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">121</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">w</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">122</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">h</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">123</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">flag</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">idle</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">124</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">pos</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="ln">125</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">curr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cCoo</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">126</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cCoo</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">127</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">ratio</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="ln">128</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">ratio</span><span class="p">.</span><span class="nx">curr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cCoo</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">129</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">ratio</span><span class="p">.</span><span class="nx">prev</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cCoo</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">130</span><span class="cl">    <span class="nx">el</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;mousemove&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)=&gt;{</span><span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">flag</span><span class="o">|=</span><span class="k">this</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">move</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">cb</span><span class="p">(</span><span class="k">this</span><span class="p">)});</span>
</span></span><span class="line"><span class="ln">131</span><span class="cl">    <span class="nx">el</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;mousedown&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)=&gt;{</span><span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">flag</span><span class="o">|=</span><span class="k">this</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">down</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">cb</span><span class="p">(</span><span class="k">this</span><span class="p">)});</span>
</span></span><span class="line"><span class="ln">132</span><span class="cl">    <span class="nx">el</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;mouseup&#34;</span><span class="p">,</span>   <span class="p">(</span><span class="nx">event</span><span class="p">)=&gt;{</span><span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">flag</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">idle</span><span class="p">;</span>  <span class="k">this</span><span class="p">.</span><span class="nx">cb</span><span class="p">(</span><span class="k">this</span><span class="p">)});</span>
</span></span><span class="line"><span class="ln">133</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln">134</span><span class="cl">
</span></span><span class="line"><span class="ln">135</span><span class="cl">  <span class="nx">update</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">136</span><span class="cl">    <span class="kd">let</span> <span class="nx">bcr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">137</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">curr</span><span class="p">.</span><span class="nx">copy_to</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">prev</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">138</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">ratio</span><span class="p">.</span><span class="nx">curr</span><span class="p">.</span><span class="nx">copy_to</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ratio</span><span class="p">.</span><span class="nx">prev</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">139</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">ratio</span><span class="p">.</span><span class="nx">curr</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">-</span> <span class="nx">bcr</span><span class="p">.</span><span class="nx">left</span><span class="p">)</span> <span class="o">/</span> <span class="nx">bcr</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">140</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">ratio</span><span class="p">.</span><span class="nx">curr</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">-</span> <span class="nx">bcr</span><span class="p">.</span><span class="nx">top</span><span class="p">)</span> <span class="o">/</span> <span class="nx">bcr</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">141</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">curr</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ratio</span><span class="p">.</span><span class="nx">curr</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">w</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">142</span><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">curr</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ratio</span><span class="p">.</span><span class="nx">curr</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">h</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">143</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln">144</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">145</span><span class="cl">
</span></span><span class="line"><span class="ln">146</span><span class="cl"><span class="kd">function</span> <span class="nx">canvasDrawDot</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">147</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">148</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&#34;white&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">149</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">filter</span> <span class="o">=</span> <span class="s2">&#34;blur(2px)&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">150</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">151</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">152</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">153</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">154</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">155</span><span class="cl">
</span></span><span class="line"><span class="ln">156</span><span class="cl"><span class="kd">function</span> <span class="nx">canvasDrawLine</span><span class="p">(</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">157</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">158</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">strokeStyle</span> <span class="o">=</span> <span class="s2">&#34;white&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">159</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">filter</span> <span class="o">=</span> <span class="s2">&#34;blur(2px)&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">160</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">lineWidth</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">161</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">lineCap</span> <span class="o">=</span> <span class="s2">&#34;round&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">162</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">163</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">moveTo</span><span class="p">(</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">164</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">lineTo</span><span class="p">(</span><span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">165</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">166</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">167</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">168</span><span class="cl">
</span></span><span class="line"><span class="ln">169</span><span class="cl">
</span></span><span class="line"><span class="ln">170</span><span class="cl"><span class="kd">function</span> <span class="nx">appInit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">171</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">172</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&#34;black&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">173</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">canvasInput</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="nx">canvasInput</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">174</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">canvasInput</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="nx">canvasInput</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">175</span><span class="cl">  <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">176</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">177</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&#34;white&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">178</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">canvasVisual</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="nx">canvasVisual</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">179</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">canvasVisual</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="nx">canvasVisual</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">180</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">181</span><span class="cl">  <span class="nx">buffers</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">zeros</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">182</span><span class="cl">  <span class="nx">buffers</span><span class="p">.</span><span class="nx">ds32</span><span class="p">.</span><span class="nx">zeros</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">183</span><span class="cl">  <span class="nx">canvasVisualDrawAnnotations</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">184</span><span class="cl">  <span class="nx">canvasVisualDrawBuffers</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">185</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">186</span><span class="cl">
</span></span><span class="line"><span class="ln">187</span><span class="cl"><span class="kd">function</span> <span class="nx">drawMatrix2D</span><span class="p">(</span><span class="nx">mat_src</span><span class="p">,</span> <span class="nx">mat_tmp</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">188</span><span class="cl">  <span class="kr">const</span> <span class="nx">imd</span> <span class="o">=</span> <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">mat_tmp</span><span class="p">.</span><span class="nx">w</span><span class="p">,</span> <span class="nx">mat_tmp</span><span class="p">.</span><span class="nx">h</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">189</span><span class="cl">  <span class="nx">Interpolations</span><span class="p">.</span><span class="nx">bilinear_a</span><span class="p">(</span><span class="nx">mat_tmp</span><span class="p">.</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">mat_tmp</span><span class="p">.</span><span class="nx">w</span><span class="p">,</span> <span class="nx">mat_tmp</span><span class="p">.</span><span class="nx">h</span><span class="p">,</span> <span class="nx">mat_src</span><span class="p">.</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">mat_src</span><span class="p">.</span><span class="nx">w</span><span class="p">,</span> <span class="nx">mat_src</span><span class="p">.</span><span class="nx">h</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">190</span><span class="cl">  <span class="nx">mat_tmp</span><span class="p">.</span><span class="nx">unloadImageData</span><span class="p">(</span><span class="nx">imd</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">191</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">putImageData</span><span class="p">(</span><span class="nx">imd</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">192</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">strokeStyle</span> <span class="o">=</span> <span class="s2">&#34;green&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">193</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">rect</span><span class="p">(</span><span class="nx">x</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="nx">y</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="nx">mat_tmp</span><span class="p">.</span><span class="nx">w</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="nx">mat_tmp</span><span class="p">.</span><span class="nx">h</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">194</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">195</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">196</span><span class="cl">
</span></span><span class="line"><span class="ln">197</span><span class="cl"><span class="kd">function</span> <span class="nx">drawText</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">align</span><span class="o">=</span><span class="s2">&#34;left&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">198</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">199</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s2">&#34;black&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">200</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="s2">&#34;32px monospace&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">201</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">textBaseline</span> <span class="o">=</span> <span class="s2">&#34;middle&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="ln">202</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">textAlign</span> <span class="o">=</span> <span class="nx">align</span><span class="p">;</span>  
</span></span><span class="line"><span class="ln">203</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">204</span><span class="cl">  <span class="nx">canvasVisualCtx</span><span class="p">.</span><span class="nx">restore</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">205</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">206</span><span class="cl">
</span></span><span class="line"><span class="ln">207</span><span class="cl"><span class="kd">function</span> <span class="nx">canvasVisualDrawAnnotations</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">208</span><span class="cl">  <span class="nx">drawText</span><span class="p">(</span><span class="s2">&#34;input&#34;</span><span class="p">,</span> <span class="mi">30</span><span class="o">+</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">temp_buf</span><span class="p">.</span><span class="nx">f24</span><span class="p">.</span><span class="nx">w</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&#34;center&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">209</span><span class="cl">  <span class="nx">drawText</span><span class="p">(</span><span class="s2">&#34;downsample 32x32&#34;</span><span class="p">,</span> <span class="mi">30</span><span class="o">+</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">temp_buf</span><span class="p">.</span><span class="nx">f24</span><span class="p">.</span><span class="nx">w</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="mi">55</span><span class="p">,</span> <span class="s2">&#34;center&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">210</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">211</span><span class="cl">
</span></span><span class="line"><span class="ln">212</span><span class="cl"><span class="kd">function</span> <span class="nx">canvasVisualDrawBuffers</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">213</span><span class="cl">  <span class="nx">drawMatrix2D</span><span class="p">(</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">ds32</span><span class="p">,</span> <span class="nx">temp_buf</span><span class="p">.</span><span class="nx">f24</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">214</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">215</span><span class="cl">
</span></span><span class="line"><span class="ln">216</span><span class="cl"><span class="kr">const</span> <span class="nx">cursorHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cCursorHandler</span><span class="p">(</span><span class="nx">canvasInput</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">217</span><span class="cl">  <span class="p">(</span><span class="nx">h</span><span class="p">)=&gt;{</span>
</span></span><span class="line"><span class="ln">218</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">flag</span> <span class="o">&amp;</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">down</span> <span class="o">||</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flag</span> <span class="o">===</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">down</span> <span class="o">|</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">move</span><span class="p">)){</span>
</span></span><span class="line"><span class="ln">219</span><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">curr</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">prev</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">220</span><span class="cl">        <span class="nx">canvasDrawDot</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">curr</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">curr</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">221</span><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">222</span><span class="cl">        <span class="nx">canvasDrawLine</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">prev</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">prev</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">curr</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">curr</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">223</span><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="ln">224</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">225</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">flag</span> <span class="o">===</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="p">.</span><span class="nx">idle</span><span class="p">){</span>
</span></span><span class="line"><span class="ln">226</span><span class="cl">      <span class="kr">const</span> <span class="nx">imd</span> <span class="o">=</span> <span class="nx">canvasInputCtx</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">canvasInput</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="nx">canvasInput</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">227</span><span class="cl">      <span class="nx">buffers</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">loadImageData</span><span class="p">(</span><span class="nx">imd</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="ln">228</span><span class="cl">      <span class="nx">forward</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">229</span><span class="cl">      <span class="nx">canvasVisualDrawBuffers</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">230</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">231</span><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="ln">232</span><span class="cl">
</span></span><span class="line"><span class="ln">233</span><span class="cl"><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;canvasClear&#34;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&#34;click&#34;</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)=&gt;{</span>
</span></span><span class="line"><span class="ln">234</span><span class="cl">  <span class="nx">appInit</span><span class="p">();</span>
</span></span><span class="line"><span class="ln">235</span><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="ln">236</span><span class="cl">
</span></span><span class="line"><span class="ln">237</span><span class="cl"><span class="nx">appInit</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">238</span><span class="cl"><span class="p">}</span></span></span></code></pre></div>

<script defer>window.onload = function()
{

const canvasInput = document.getElementById("canvasInput");
const canvasInputCtx = canvasInput.getContext("2d", {"alpha":false});
const canvasVisual = document.getElementById("canvasVisual");
const canvasVisualCtx = canvasVisual.getContext("2d", {"alpha":false});
const ftoi = (v) => ~~v;
const arrcp = (src, dst) => {for(let i=0; i<src.length; i++){dst[i]=src[i]}}


class Interpolations {

  static nearest(a, b, t) {
    return t >= .5 ? b : a;
  };

  static linear(a, b, t) {
    return a + (b - a) * t
  };

  static bilinear(a1, b1, a2, b2, t1, t2) {
    return Interpolations.linear(
      Interpolations.linear(a1, b1, t1),
      Interpolations.linear(a2, b2, t1),
      t2
    )
  };

  static bilinear_a(arrDst, wDst, hDst, arrSrc, wSrc, hSrc) {
    let i, ax, ay, bx, by, rx, ry, bi0, bi1, bi2, bi3;
    for (i=0; i<arrDst.length; i++) {
      ax = i % wDst;
      ay = ftoi(i / wDst);
      rx = ax / wDst;
      ry = ay / hDst;
      bx = ftoi(rx * (hSrc-1));
      by = ftoi(ry * (wSrc-1));
      rx %= 1;
      ry %= 1;
      arrDst[i] = Interpolations.bilinear(
        arrSrc[bx+wSrc*by],     arrSrc[(bx+1)+wSrc*by],
        arrSrc[bx+wSrc*(by+1)], arrSrc[(bx+1)+wSrc*(by+1)],
        rx, ry
      );
    };
  };
}


class cFloat32Matrix2D {
  constructor (w, h) {
    this.w = w; this.h = h; this.l = w*h;
    this.buf = new Float32Array(this.l);
  }
  itox(i) {return i % this.w};
  itoy(i) {return ftoi(i / this.w)};
  ctoi(x, y) {return x + (y * this.w)};
  get(x, y) {return this.buf[this.ctoi(x, y)]};
  set(x, y, v) {this.buf[this.ctoi(x, y)] = v;};
  zeros() {
    for (let i=0; i<this.buf.length; i++) {
      this.buf[i] = 0;
    }
  }
  loadImageData(data) {
    for (let i=0; i<data.length; i+=4) {
      this.buf[ftoi(i/4)] = (data[i+0] + data[i+1] + data[i+2]) / 3 / 255;
    }
  };
  unloadImageData(data) {
    for (let i=0; i<data.length; i+=4) {
      let p = this.buf[ftoi(i/4)];
      p = p > 1 ? 1 : p;
      p = p < 0 ? 0 : p;
      p = ftoi(p * 255);
      data[i+0] = p;
      data[i+1] = p;
      data[i+2] = p;
    }
  };
}

const temp_buf = {};
temp_buf.f12 = new cFloat32Matrix2D(120, 120);
temp_buf.f16 = new cFloat32Matrix2D(160, 160);
temp_buf.f24 = new cFloat32Matrix2D(240, 240);


// LeNet setup
const buffers = {};
buffers.input = new cFloat32Matrix2D(canvasInput.width, canvasInput.height);
buffers.ds32 = new cFloat32Matrix2D(32, 32);


function forward() {
  Interpolations.bilinear_a(buffers.ds32.buf,  buffers.ds32.w,  buffers.ds32.h,
                            buffers.input.buf, buffers.input.w, buffers.input.h);
}



class cCoo {
  constructor (x=0, y=0) {
    this.x = x;
    this.y = y;
  }
  add(coo) {this.x += coo.x; this.y += coo.y; return this};
  sub(coo) {this.x -= coo.x; this.y -= coo.y; return this};
  mul(coo) {this.x *= coo.x; this.y *= coo.y; return this};
  div(coo) {this.x /= coo.x; this.y /= coo.y; return this};
  copy_to(coo) {coo.x = this.x; coo.y = this.y; return coo};
  eq(coo) {return coo.x == this.x && coo.y == this.y};
}

class cCursorHandler {
  flags = {'idle': 0, 'move': 1, 'down': 2};
  constructor (el, callback=(handler)=>{}) {
    this.el = el;
    this.cb = callback;
    this.w = el.width;
    this.h = el.height;
    this.flag = this.flags.idle;
    this.pos = {};
    this.pos.curr = new cCoo();
    this.pos.prev = new cCoo();
    this.ratio = {};
    this.ratio.curr = new cCoo();
    this.ratio.prev = new cCoo();
    el.addEventListener("mousemove", (event)=>{this.update(event); this.flag|=this.flags.move; this.cb(this)});
    el.addEventListener("mousedown", (event)=>{this.update(event); this.flag|=this.flags.down; this.cb(this)});
    el.addEventListener("mouseup",   (event)=>{this.update(event); this.flag=this.flags.idle;  this.cb(this)});
  }

  update (event) {
    let bcr = this.el.getBoundingClientRect();
    this.pos.curr.copy_to(this.pos.prev);
    this.ratio.curr.copy_to(this.ratio.prev);
    this.ratio.curr.x = (event.clientX - bcr.left) / bcr.width;
    this.ratio.curr.y = (event.clientY - bcr.top) / bcr.height;
    this.pos.curr.x = ftoi(this.ratio.curr.x * this.w);
    this.pos.curr.y = ftoi(this.ratio.curr.y * this.h);
  }
}

function canvasDrawDot(x, y) {
  canvasInputCtx.save()
  canvasInputCtx.fillStyle = "white";
  canvasInputCtx.filter = "blur(2px)";
  canvasInputCtx.beginPath();
  canvasInputCtx.arc(x, y, 10, 0, 2 * Math.PI);
  canvasInputCtx.fill();
  canvasInputCtx.restore()
}

function canvasDrawLine(x1, y1, x2, y2) {
  canvasInputCtx.save()
  canvasInputCtx.strokeStyle = "white";
  canvasInputCtx.filter = "blur(2px)";
  canvasInputCtx.lineWidth = 20;
  canvasInputCtx.lineCap = "round";
  canvasInputCtx.beginPath();
  canvasInputCtx.moveTo(x1, y1);
  canvasInputCtx.lineTo(x2, y2);
  canvasInputCtx.stroke();
  canvasInputCtx.restore()
}


function appInit() {
  canvasInputCtx.save()
  canvasInputCtx.fillStyle = "black";
  canvasInputCtx.clearRect(0,0,canvasInput.width,canvasInput.height);
  canvasInputCtx.fillRect(0,0,canvasInput.width,canvasInput.height);
  canvasInputCtx.restore()
  canvasVisualCtx.save();
  canvasVisualCtx.fillStyle = "white";
  canvasVisualCtx.clearRect(0,0,canvasVisual.width,canvasVisual.height);
  canvasVisualCtx.fillRect(0,0,canvasVisual.width,canvasVisual.height);
  canvasVisualCtx.restore();
  buffers.input.zeros();
  buffers.ds32.zeros();
  canvasVisualDrawAnnotations();
  canvasVisualDrawBuffers();
}

function drawMatrix2D(mat_src, mat_tmp, x, y) {
  const imd = canvasVisualCtx.getImageData(x, y, mat_tmp.w, mat_tmp.h);
  Interpolations.bilinear_a(mat_tmp.buf, mat_tmp.w, mat_tmp.h, mat_src.buf, mat_src.w, mat_src.h);
  mat_tmp.unloadImageData(imd.data);
  canvasVisualCtx.putImageData(imd, x, y);
  canvasVisualCtx.strokeStyle = "green";
  canvasVisualCtx.rect(x-2,y-2,mat_tmp.w+4, mat_tmp.h+4);
  canvasVisualCtx.stroke();
}

function drawText(text, x, y, align="left") {
  canvasVisualCtx.save();
  canvasVisualCtx.fillStyle = "black";
  canvasVisualCtx.font = "32px monospace";
  canvasVisualCtx.textBaseline = "middle";
  canvasVisualCtx.textAlign = align;  
  canvasVisualCtx.fillText(text, x, y);
  canvasVisualCtx.restore();
}

function canvasVisualDrawAnnotations() {
  drawText("input", 30+ftoi(temp_buf.f24.w/2), 30, "center");
  drawText("downsample 32x32", 30+ftoi(temp_buf.f24.w/2), 55, "center");
}

function canvasVisualDrawBuffers() {
  drawMatrix2D(buffers.ds32, temp_buf.f24, 30, 80);
}

const cursorHandler = new cCursorHandler(canvasInput,
  (h)=>{
    if (h.flag & h.flags.down || h.flag === (h.flags.down | h.flags.move)){
      if (h.pos.curr.eq(h.pos.prev)) {
        canvasDrawDot(h.pos.curr.x, h.pos.curr.y);
      } else {
        canvasDrawLine(h.pos.prev.x, h.pos.prev.y, h.pos.curr.x, h.pos.curr.y);
      }
    }
    if (h.flag === h.flags.idle){
      const imd = canvasInputCtx.getImageData(0,0,canvasInput.width,canvasInput.height);
      buffers.input.loadImageData(imd.data);
      forward();
      canvasVisualDrawBuffers();
    }
  });

document.getElementById("canvasClear").addEventListener("click", (e)=>{
  appInit();
})

appInit()
}</script>




  </div>
  

  
  <br>
  <br>
  <br>
  <br>
  <p class="tc">Built with <a a target="_blank" class="extern" href="https://gohugo.io/">Hugo</a> | previoip (c) 2025</p>
</body>

</html>


